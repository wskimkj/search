<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>상품 조회</title>
  <link rel="icon" type="image/png" href="android-chrome-512x512 (1).ico">
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* --- 스타일 생략 (기존 그대로) --- */
    body { font-family: 'Pretendard', sans-serif; background: #f0f4f8; padding: 20px; }
    .app-shell { max-width: 1200px; margin: auto; background: white; border-radius: 20px; padding: 20px; }
    .card { background: #fff; padding: 16px; border-radius: 14px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);}
    .search-box { display:flex; gap:8px; flex-wrap:wrap; }
    .search-box input[type="text"] { padding: 8px 12px; border-radius:999px; border:1px solid #ccc; flex:1; }
    .search-box button { padding:8px 16px; border:none; border-radius:999px; background:#fb7185; color:white; cursor:pointer; }
    .result-table-wrap { overflow:auto; max-height:500px; }
    table { border-collapse: collapse; width:100%; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #eee; font-size:13px; }
    tr:hover { background:#fce7f3; cursor:pointer; }
    th { background:#f9fafb; position:sticky; top:0; z-index:1; }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="card">
    <h2>상품 검색</h2>
    <div class="search-box">
      <input type="text" id="keyword" placeholder="검색어 입력 (예: 코쉬카)">
      <button id="searchBtn" disabled>검색</button>
      <label>
        <input type="checkbox" id="toggleWarehouse" />
        창고
      </label>
      <label>
        <input type="checkbox" id="toggleMaterial" />
        소재
      </label>
      <label>
        <input type="checkbox" id="toggleURL" checked />
        URL
      </label>
    </div>
    <div id="status" style="margin-top:8px;">데이터 로딩 중...</div>
  </div>

  <div class="card">
    <h2>검색 결과</h2>
    <div id="result">
      <div>검색 후 결과가 표시됩니다.</div>
    </div>
  </div>
</div>

<script>
  const PRODUCT_SHEET_ID = '1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc';
  const PRODUCT_GID = '885700988';
  const PRODUCT_CSV_URL = `https://docs.google.com/spreadsheets/d/${PRODUCT_SHEET_ID}/export?format=csv&gid=${PRODUCT_GID}`;

  let products = [];
  const keywordInput = document.getElementById('keyword');
  const searchBtn = document.getElementById('searchBtn');
  const resultEl = document.getElementById('result');
  const toggleWarehouse = document.getElementById('toggleWarehouse');
  const toggleMaterial = document.getElementById('toggleMaterial');
  const toggleURL = document.getElementById('toggleURL');
  const statusEl = document.getElementById('status');

  function cleanProductName(name){
    return name ? name.replace(/\s{2,}/g,' ').trim() : '';
  }

  async function loadProducts(){
    const res = await fetch(PRODUCT_CSV_URL);
    const text = await res.text();
    const parsed = Papa.parse(text, {header:false, skipEmptyLines:true});
    const rows = parsed.data.slice(1);
    products = rows.map(r=>{
      return {
        productName: cleanProductName(r[26]),
        productCode: r[5],
        colorName: r[15],
        colorCode: r[25]
      };
    }).filter(p=>p.productName);
    statusEl.textContent = `상품 데이터 로드 완료 (${products.length}개)`;
    searchBtn.disabled = false;
  }

  function buildProductURL(name){
    const keyword = encodeURIComponent(name);
    return `https://whitesands.co.kr/product/search.html?keyword=${keyword}`;
  }

  function renderResults(filtered){
    if(!filtered.length){
      resultEl.innerHTML = `<div>검색 결과 없음</div>`;
      return;
    }
    let html = `<div class="result-table-wrap"><table>
      <thead>
        <tr>
          <th>상품명</th>
          <th>칼라명</th>
          ${toggleMaterial.checked ? '<th>소재</th>' : ''}
          ${toggleWarehouse.checked ? '<th>창고</th>' : ''}
          ${toggleURL.checked ? '<th>URL</th>' : ''}
        </tr>
      </thead>
      <tbody>`;
    filtered.forEach(p=>{
      const url = buildProductURL(p.productName);
      html += `<tr>
        <td>${p.productName}</td>
        <td>${p.colorName}</td>
        ${toggleMaterial.checked ? '<td>'+(p.material||'')+'</td>': ''}
        ${toggleWarehouse.checked ? '<td></td>':''}
        ${toggleURL.checked ? `<td><a href="${url}" target="_blank">상품페이지</a></td>`: ''}
      </tr>`;
    });
    html += `</tbody></table></div>`;
    resultEl.innerHTML = html;
  }

  function search(){
    const kw = keywordInput.value.trim().toLowerCase();
    const filtered = products.filter(p=>p.productName.toLowerCase().includes(kw));
    renderResults(filtered);
  }

  searchBtn.addEventListener('click', search);
  keywordInput.addEventListener('keydown', e=>{
    if(e.key==='Enter') search();
  });

  loadProducts();
</script>
</body>
</html>
