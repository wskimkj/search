<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="https://wskimkj.github.io/admin/css/common.css">

  <meta charset="UTF-8" />
  <title> Search </title>

  <!-- 파비콘 -->
  <link rel="icon" type="image/png" href="android-chrome-512x512 (1).ico">

  <!-- 폰트 -->
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">

  <!-- CSV 파서 -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
/* ===================== FINAL CSS (기능 유지 / 레이아웃 정상 / pill 복구) ===================== */
:root{
  --page-bg: #f7f4ff;
  --page-bg2:#eef6ff;

  --card-bg: rgba(255,255,255,.88);
  --card-stroke: rgba(170,150,230,.22);

  --text-main: #2f2a3a;
  --text-muted: #6e6a82;

  --pink: #ff8fbc;
  --lilac:#b8a7ff;

  --radius-xl: 18px;
  --shadow-main: 0 18px 50px rgba(30,18,60,.10);
  --shadow-card: 0 10px 26px rgba(30,18,60,.08);
}

*{box-sizing:border-box;}
html,body{height:100%;}

body{
  margin:0;
  font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text-main);
  background:
    radial-gradient(900px 520px at 20% 18%, rgba(255,143,188,.25), transparent 60%),
    radial-gradient(900px 520px at 82% 24%, rgba(184,167,255,.20), transparent 58%),
    linear-gradient(180deg, var(--page-bg), var(--page-bg2));
}

/* ===== layout ===== */
.app-shell{
  min-height:100vh;
  padding:24px;
}
.inner-shell{
  max-width:1400px;
  margin:0 auto;
  background:var(--card-bg);
  border:1px solid var(--card-stroke);
  border-radius:24px;
  padding:18px 20px 20px;
  box-shadow:var(--shadow-main);
}

/* ===== header ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:14px;
}
.title-wrap h1{
  margin:0;
  font-size:20px;
  font-weight:800;
  display:flex;
  gap:10px;
  cursor:pointer;
}
.title-tag{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(255,143,188,.25);
  border:1px solid rgba(255,143,188,.35);
}
.header-right{
  font-size:12px;
  color:var(--text-muted);
}

/* ===== cards ===== */
.card{
  background:#fff;
  border:1px solid var(--card-stroke);
  border-radius:22px;
  box-shadow:var(--shadow-card);
}
.card-search{
  align-items: stretch;
}

/* ✅ Result 영역이 빈데도 커 보이는 현상 방지 */
.result-card{
  padding: 14px 16px 16px;
}
#result{
  min-height: 0 !important;
}
.no-result{
  padding: 14px 0;
  margin: 0;
  font-size: 12px;
  color: var(--text-muted);
}

/* ===== search ===== */
.card-search{
  display:flex;
  gap:14px;
  padding:12px 14px;
  align-items:flex-start;
}
.card-title{
  font-size:13px;
  font-weight:700;
  margin:0;
  white-space:nowrap;
}
.search-box{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.input-wrap{ position:relative; }
.input-wrap input{
  width:100%;
  padding:12px 42px 12px 34px;
  border-radius:999px;
  border:1px solid rgba(170,150,230,.25);
  background:#f5f3fb;
}
.input-wrap input:focus{
  outline:none;
  border-color:var(--pink);
  box-shadow:0 0 0 4px rgba(255,143,188,.18);
}
.input-icon-left{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
}
.input-icon-right{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:11px;
  color:#999;
}

/* ===== result ===== */
.result-card{ padding-top:14px; }
.result-header-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}
.result-header-right{
  font-size:11px;
  color:var(--text-muted);
}

/* ===== op legend ===== */
#opLegend.op-legend{
  display:none;
  margin:6px 0 10px;
  gap:12px;
}
#opLegend .op-legend-item{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  color:var(--text-muted);
}
.op-legend-dot{
  width:10px;
  height:10px;
  border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 0 1px rgba(170,150,230,.25);
}
.op-legend-dot.on{background:#22c55e;}
.op-legend-dot.end{background:#f97316;}
.op-legend-dot.stop{background:#ef4444;}
.op-legend-dot.pause{background:#eab308;}
.op-legend-dot.unk{background:#a3a3a3;}

/* ===== table ===== */
.result-table-wrap{
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(170,150,230,.18);
}
.result-scroll{
  max-height:520px;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
  font-size:12px;
}
th,td{
  padding:10px 12px;
  border-bottom:1px solid rgba(170,150,230,.15);
}
th{
  background:#fff;
  position:sticky;
  top:0;
  z-index:2;
  user-select:none;
}
tr:nth-child(even) td{background:#faf9fe;}
tr:hover td{background:rgba(255,143,188,.18);}

/* ===== column resize ===== */
th{ position:sticky; }
.resize-handle{
  position:absolute;
  top:0;
  right:0;
  width:10px;
  height:100%;
  cursor:col-resize;
}
.resize-handle::after{
  content:"";
  position:absolute;
  top:20%;
  bottom:20%;
  left:50%;
  width:1px;
  transform:translateX(-50%);
  background:rgba(170,150,230,.35);
  opacity:0;
}
th:hover .resize-handle::after{opacity:1;}
th.sortable{cursor:pointer; position:relative;}
.sort-indicator{
  margin-left:4px;
  font-size:10px;
  color:var(--pink);
}

/* ===== product name / status dot ===== */
.product-name-cell{
  position:relative;
  padding-left:28px;
}
.op-status-dot{
  position:absolute;
  left:10px;
  top:50%;
  transform:translateY(-50%);
  width:10px;
  height:10px;
  border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 0 1px rgba(170,150,230,.25);
}

/* 상태별 색 */
.op-status-dot--on    { background:#22c55e; }
.op-status-dot--end   { background:#f97316; }
.op-status-dot--stop  { background:#ef4444; }
.op-status-dot--pause { background:#eab308; }
.op-status-dot--unk   { background:#a3a3a3; }

/* ===== stock pill ===== */
.stock-pill{
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.stock-pill-dot{
  width:6px;
  height:6px;
  border-radius:50%;
}
.stock-pill-green{background:#e9fbf3;}
.stock-pill-green .stock-pill-dot{background:#22c55e;}
.stock-pill-yellow{background:#fff7d6;}
.stock-pill-yellow .stock-pill-dot{background:#facc15;}
.stock-pill-red{background:#ffe4ee;}
.stock-pill-red .stock-pill-dot{background:#ff8fbc;}

/* ===== misc ===== */
.kw-mark{background:yellow;padding:0 2px;}
#toast{
  position:fixed;
  right:18px;
  bottom:18px;
  padding:10px 12px;
  border-radius:14px;
  background:#fff;
  border:1px solid rgba(255,143,188,.35);
  opacity:0;
}
#toast.show{opacity:1;}
#status{
  font-size: 12px !important;
  line-height: 1.2 !important;
  margin-top: 6px !important;
  color: var(--text-muted) !important;
}
#status strong{
  font-size: 12px !important;
  font-weight: 600 !important;
  color: var(--text-main) !important;
}
@media(max-width:860px){
  .header{flex-direction:column;gap:10px;}
  .card-search{flex-direction:column;}
}

/* ===== slim search bar ===== */
.input-wrap.slim{ position:relative; }
.input-wrap.slim input{
  height: 42px;
  padding: 0 78px 0 42px;
  border-radius: 999px;
  border: 1px solid rgba(170,150,230,.22);
  background: rgba(245,243,251,.75);
  font-size: 13px;
}
.input-wrap.slim input:focus{
  outline:none;
  border-color: rgba(255,143,188,.55);
  box-shadow: 0 0 0 4px rgba(255,143,188,.16);
}
.input-wrap.slim .input-icon-left{
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;
  height:18px;
  opacity:.95;
}
.icon-search{ width:18px; height:18px; display:block; }
.input-wrap.slim .input-icon-right{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:11px;
  color: rgba(110,106,130,.55);
  pointer-events:none;
}
.clear-btn{
  position:absolute;
  right:52px;
  top:50%;
  transform:translateY(-50%);
  width:22px;
  height:22px;
  border-radius:999px;
  border:1px solid rgba(170,150,230,.18);
  background: rgba(255,255,255,.65);
  color: rgba(110,106,130,.75);
  font-size:16px;
  line-height:1;
  cursor:pointer;
  display:none;
}
.clear-btn:hover{
  background: rgba(255,143,188,.12);
  border-color: rgba(255,143,188,.22);
}
.type-pills{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.type-pill{
  height:34px;
  padding:0 14px;
  border-radius:999px;
  border:1px solid rgba(170,150,230,.25);
  background:#fff;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  font-size:13px;
  user-select:none;
  transition: background .12s ease, border-color .12s ease, transform .06s ease;
}
.type-pill input{ display:none; }
.type-pill.active{
  background:rgba(255,143,188,.25);
  border-color:rgba(255,143,188,.45);
}
.type-pill:active{ transform: scale(.98); }
.input-wrap .input-icon-left{ font-size:0; }
.text-right{ text-align:right; }
.text-center{ text-align:center; }

/* ===========================
   미리보기 모달
   =========================== */
.pv-modal{ position:fixed; inset:0; display:none; z-index:9999; }
.pv-modal.show{ display:block; }
.pv-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
.pv-panel{
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:min(1100px, 92vw);
  height:min(86vh, 900px);
  background:#fff;
  border-radius:18px;
  border:1px solid rgba(170,150,230,.22);
  box-shadow:0 18px 50px rgba(30,18,60,.18);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.pv-topbar{
  height:46px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 12px 0 14px;
  border-bottom:1px solid rgba(170,150,230,.18);
  background:rgba(245,243,251,.75);
}
.pv-title{ font-size:13px; font-weight:700; color:var(--text-main); }
.pv-actions{ display:flex; gap:8px; align-items:center; }
.pv-btn{
  height:30px;
  padding:0 10px;
  border-radius:999px;
  border:1px solid rgba(170,150,230,.22);
  background:#fff;
  font-size:12px;
  cursor:pointer;
  text-decoration:none;
  color:var(--text-main);
  display:inline-flex;
  align-items:center;
}
.pv-btn:hover{
  background: rgba(255,143,188,.12);
  border-color: rgba(255,143,188,.22);
}
.pv-body{ position:relative; flex:1; }
.pv-loading{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:var(--text-muted);
  background:rgba(255,255,255,.85);
  z-index:2;
}
.pv-frame{
  width:100%;
  height:100%;
  border:0;
  display:block;
}

/* ===========================
   운영 점 Hover 툴팁 (카드형)
   =========================== */
.extra-tooltip{
  position: fixed;
  z-index: 99999;
  display: none;
  min-width: 280px;
  max-width: 420px;
  padding: 12px 12px 10px;
  border-radius: 16px;
  background: rgba(255,255,255,.97);
  border: 1px solid rgba(170,150,230,.22);
  box-shadow: 0 18px 50px rgba(30,18,60,.18);
  font-size: 12px;
  color: var(--text-main);
  line-height: 1.35;
  overflow:hidden;
}
.extra-tooltip .t-title{
  font-weight: 900;
  font-size: 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom: 8px;
}
.extra-tooltip .t-title .badge{
  font-size:10px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(170,150,230,.22);
  background: rgba(245,243,251,.75);
  color: var(--text-muted);
}
.extra-tooltip .t-list{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.extra-tooltip .t-item{
  display:flex;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(170,150,230,.16);
  background: rgba(245,243,251,.55);
}
.extra-tooltip .t-k{
  width: 76px;
  font-weight:700;
  color: var(--text-muted);
  flex: 0 0 auto;
}
.extra-tooltip .t-v{
  flex: 1 1 auto;
  word-break: break-word;
  color: var(--text-main);
}
.extra-tooltip .t-hint{
  margin-top:8px;
  font-size:10px;
  color: rgba(110,106,130,.65);
}
/* ✅ 위젯(iframe)로 띄울 때는 검색바/헤더 숨기고 결과만 보여주기 */
body.embed .header{ display:none !important; }
body.embed .card.card-search{ display:none !important; }
body.embed .inner-shell{ padding-top:14px !important; }

    
  </style>
</head>

<body>
  <div class="app-shell">
    <div class="inner-shell">
      <div class="header">
        <div class="header-left">
          <div class="title-wrap">
            <h1>
              Search
              <span class="title-tag"> PlayMD </span>
            </h1>
          </div>
        </div>
        <div class="header-right">
          <div style="margin-top: 4px;">
            <span id="stockInfo">로딩 중...</span>
          </div>
        </div>
      </div>

      <div class="content-row">
        <!-- 검색 카드 -->
        <div class="card card-search">
          <div class="search-box">
            <div class="input-wrap slim">
              <span class="input-icon-left" aria-hidden="true">
                <svg class="icon-search" viewBox="0 0 24 24" fill="none">
                  <path d="M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="rgba(110,106,130,.55)" stroke-width="2"/>
                  <path d="M20 20l-3.5-3.5" stroke="rgba(255,143,188,.80)" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>

              <input type="text" id="keyword" placeholder="(예: 상품명, 상품코드, 칼라코드 등)" />
              <button type="button" id="clearKeyword" class="clear-btn" aria-label="검색어 지우기">×</button>
              <span class="input-icon-right">Enter ↵</span>
            </div>

            <div class="type-pills" id="filterPills">
              <label class="type-pill" for="warehouse">
                <input type="checkbox" id="warehouse">
                창고
              </label>

              <label class="type-pill" for="material">
                <input type="checkbox" id="material">
                소재
              </label>

              <label class="type-pill" for="stock">
                <input type="checkbox" id="stock">
                재고
              </label>
            </div>

            <div class="status" id="status">
              데이터 불러오는 중...
            </div>
          </div>
        </div>

        <!-- 결과 카드 -->
        <div class="card result-card">
          <div class="result-header-row">
            <h2 class="card-title"><span class="icon"></span></h2>
          </div>

          <div id="opLegend" class="op-legend">
            <span class="op-legend-item">
              <span class="op-legend-dot on"></span> 운영
            </span>
            <span class="op-legend-item">
              <span class="op-legend-dot end"></span> 소진 후 종료
            </span>
            <span class="op-legend-item">
              <span class="op-legend-dot stop"></span> 단종
            </span>
            <span class="op-legend-item">
              <span class="op-legend-dot pause"></span> 일시 중단
            </span>
            <span class="op-legend-item">
              <span class="op-legend-dot unk"></span> 정보 없음
            </span>
          </div>

          <div id="result">
            <div class="no-result"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">복사</div>

  <!-- 미리보기 모달 -->
  <div id="previewModal" class="pv-modal" aria-hidden="true">
    <div class="pv-backdrop"></div>
    <div class="pv-panel" role="dialog" aria-modal="true">
      <div class="pv-topbar">
        <div class="pv-title">상품 미리보기</div>
        <div class="pv-actions">
          <a id="pvOpenNewTab" class="pv-btn" href="#" target="_blank" rel="noopener">↗️</a>
          <button type="button" id="pvClose" class="pv-btn">❌</button>
        </div>
      </div>

      <div class="pv-body">
        <div id="pvLoading" class="pv-loading">불러오는 중…</div>
        <iframe id="pvFrame" class="pv-frame" loading="lazy"></iframe>
      </div>
    </div>
  </div>

  <!-- 운영 점 Hover 툴팁 -->
  <div id="extraTooltip" class="extra-tooltip" role="tooltip" aria-hidden="true"></div>

  <script>
    // ===== 시트 설정 =====
    const PRODUCT_SHEET_ID = '1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc';
    const PRODUCT_GID = '885700988';

    const STOCK_SHEET_ID = '1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM';
    const STOCK_GID = '366983013';

    const OPER_SHEET_ID = '1F4EC5w1VPmFpwSbw0LuIv5QkwSSs8YkCBPZKY3h-z64';
    const OPER_GID = '2108422262';

    // ✅ 같은 스프레드시트 파일 안에서 역할별 gid 분리
    // (A) 운영 점 hover 툴팁용 "부가정보" 시트 (gid=1305011805)
    const EXTRA_INFO_SHEET_ID = '1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM';
    const EXTRA_INFO_GID = '1305011805';

    // (B) 재고 pill 클릭 → 상품번호(product_no) 매칭/미리보기 연동 시트 (gid=2050011179)
    const PREVIEW_MAP_SHEET_ID = '1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM';
    const PREVIEW_MAP_GID = '2050011179';

    const PRODUCT_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${PRODUCT_SHEET_ID}/export?format=csv&gid=${PRODUCT_GID}`;
    const STOCK_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${STOCK_SHEET_ID}/export?format=csv&gid=${STOCK_GID}`;
    const OPER_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${OPER_SHEET_ID}/export?format=csv&gid=${OPER_GID}`;

    const EXTRA_INFO_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${EXTRA_INFO_SHEET_ID}/export?format=csv&gid=${EXTRA_INFO_GID}`;
    const PREVIEW_MAP_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${PREVIEW_MAP_SHEET_ID}/export?format=csv&gid=${PREVIEW_MAP_GID}`;

    // ===== 전역 데이터 =====
    let products = [];
    let stockEntriesByColorCode = {};
    let sizeByColorCode = {};
    let stockUpdatedAt = '';

    let showMaterial = false;
    let showWarehouse = false;
    let inStockOnly = false;
    let opStatusByColorCode = {};

    // ✅ 재고 시트 J열(상품번호) 매핑: colorCode -> productNo
    let productNoByColorCode = {};

    // ✅ (A) 툴팁용 부가정보: productCode -> { sizeAdjust, trim, madeIn, careLabel, feature }
    let extraInfoByProductCode = {};

    // ✅ (B) 미리보기 매칭용: productCode(AH) -> productNo(BL)
    let productNoByCode_AH = {};
    let extraRowsTextIndex = []; // [{ text, productNo }]

    let sortKey = 'productName';
    let sortDir = 'asc';

    let lastKeyword = '';

    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const stockInfoEl = document.getElementById('stockInfo');

    const keywordInput = document.getElementById('keyword');
    const clearBtn = document.getElementById('clearKeyword');

    const toggleMaterialInput = document.getElementById('material');
    const toggleWarehouseInput = document.getElementById('warehouse');
    const toggleInStockOnlyInput = document.getElementById('stock');

    const toastEl = document.getElementById('toast');
    const opLegendEl = document.getElementById('opLegend');
    const resultInfoEl = document.getElementById('resultInfo'); // (현재 DOM에 없어서 null일 수 있음)

    // 미리보기 모달 DOM
    const previewModalEl = document.getElementById('previewModal');
    const pvBackdropEl = previewModalEl ? previewModalEl.querySelector('.pv-backdrop') : null;
    const pvCloseEl = document.getElementById('pvClose');
    const pvFrameEl = document.getElementById('pvFrame');
    const pvLoadingEl = document.getElementById('pvLoading');
    const pvOpenNewTabEl = document.getElementById('pvOpenNewTab');

    // 운영 점 Hover 툴팁 DOM
    const extraTooltipEl = document.getElementById('extraTooltip');

    const regexBracket = /\[[^\]]*\]/g;
    const regexSeason  = /^\s*[0-9]{2}\s*(FW|SS)\s*/i;

    // ✅✅ 로딩 최적화 플래그 (진짜 필요할 때만)
    let extraInfoLoaded = false;
    let previewMapLoaded = false;
    let operLoaded = false;

    function cleanProductName(name) {
      if (!name) return '';
      return String(name)
        .replace(/[\r\n]+/g, '')
        .replace(/\u00A0/g, ' ')
        .replace(regexBracket, '')
        .replace(regexSeason, '')
        .replace(/\s*\([^)]*\)\s*[^()]*$/, '')
        .replace(/\([^)]*\)\s*$/, '')
        .replace(/\s{2,}/g, ' ')
        .trim();
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // ✅✅ PapaParse: download + worker 로 파싱 부담을 메인 스레드에서 분리
    function parseCSVFromUrl(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          worker: true,
          header: false,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data || []),
          error: (err) => reject(err)
        });
      });
    }

    function showToast(msg) {
      if (!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => {
        toastEl.classList.remove('show');
      }, 1400);
    }

    function updateLegendVisibility() {
      if (!opLegendEl) return;
      const hasData = Object.keys(opStatusByColorCode).length > 0;
      opLegendEl.style.display = hasData ? 'flex' : 'none';
    }

    // ====== (공통) product_no 정규화 ======
    function normalizeProductNo(v){
      if (v === null || v === undefined) return '';
      const s = String(v).trim();
      if (!s) return '';
      return s.replace(/[^\d]/g, '');
    }

    // ✅ 미리보기 모달 열기/닫기 (✅ 같은 URL 연속 로드도 강제 리로드)
    function openPreviewByProductNo(productNo){
      const pno = normalizeProductNo(productNo);
      if (!pno) {
        showToast('상품번호를 찾지 못했어요.');
        return;
      }

      const url = `https://whitesands.co.kr/product/detail.html?product_no=${encodeURIComponent(pno)}`;

      if (!previewModalEl || !pvFrameEl || !pvLoadingEl || !pvOpenNewTabEl) {
        window.open(url, '_blank', 'noopener');
        return;
      }

      pvOpenNewTabEl.href = url;
      pvLoadingEl.style.display = 'flex';

      // ✅ 강제 리로드
      pvFrameEl.src = 'about:blank';
      previewModalEl.classList.add('show');
      previewModalEl.setAttribute('aria-hidden', 'false');

      requestAnimationFrame(() => {
        pvFrameEl.src = url;
      });

      showToast('미리보기 여는 중...');
    }

    function closePreview(){
      if (!previewModalEl || !pvFrameEl || !pvLoadingEl) return;
      previewModalEl.classList.remove('show');
      previewModalEl.setAttribute('aria-hidden', 'true');
      pvLoadingEl.style.display = 'flex';
      pvFrameEl.src = 'about:blank';
    }

    if (pvFrameEl) {
      pvFrameEl.addEventListener('load', () => {
        if (pvFrameEl.src === 'about:blank') return;
        if (pvLoadingEl) pvLoadingEl.style.display = 'none';
      });
    }

    if (pvCloseEl) pvCloseEl.addEventListener('click', closePreview);
    if (pvBackdropEl) pvBackdropEl.addEventListener('click', closePreview);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePreview();
    });

    async function loadProducts() {
      const rows = await parseCSVFromUrl(PRODUCT_CSV_URL);
      if (rows.length < 2) return;

      const idxProductCode = 5;
      const idxColorName   = 15;
      const idxBarcode     = 20;
      const idxMaterial    = 22;
      const idxColorCode   = 25;
      const idxProductName = 26;

      products = rows.slice(1).map(row => {
        const rawName = row[idxProductName] || '';
        const cleanedName = cleanProductName(rawName);

        return {
          productCode: row[idxProductCode] || '',
          colorName:   row[idxColorName]   || '',
          barcode:     row[idxBarcode]     || '',
          material:    row[idxMaterial]    || '',
          colorCode:   row[idxColorCode]   || '',
          rawName,
          productName: cleanedName
        };
      }).filter(p => p.productName);
    }

    async function loadStock() {
      const rows = await parseCSVFromUrl(STOCK_CSV_URL);
      if (!rows.length) return;

      stockUpdatedAt = (rows[0][1] || '').trim();
      stockInfoEl.textContent = stockUpdatedAt || '미기재';

      stockEntriesByColorCode = {};
      sizeByColorCode = {};
      productNoByColorCode = {};

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row.length) continue;

        const colorCode = (row[0] || '').trim();
        if (!colorCode) continue;

        const size      = (row[1] || '').trim();
        const warehouse = (row[2] || '').trim() || '미정';

        // ✅ J열 = 상품번호 (0-based index: 9)
        const productNo = (row[9] || '').toString().trim();
        if (productNo && !productNoByColorCode[colorCode]) {
          productNoByColorCode[colorCode] = productNo;
        }

        // 재고는 K열(row[10])
        let qtyRaw      = (row[10] || '').toString().trim();
        if (!qtyRaw) continue;

        qtyRaw = qtyRaw.replace(/,/g, '');
        const qty = Number(qtyRaw);
        if (isNaN(qty)) continue;

        if (!stockEntriesByColorCode[colorCode]) {
          stockEntriesByColorCode[colorCode] = [];
        }
        stockEntriesByColorCode[colorCode].push({ warehouse, size, qty });

        if (!sizeByColorCode[colorCode] && size) {
          sizeByColorCode[colorCode] = size;
        }
      }
    }

    async function loadOperationStatus() {
      const rows = await parseCSVFromUrl(OPER_CSV_URL);
      if (rows.length < 2) return;

      opStatusByColorCode = opStatusByColorCode || {};

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const colorCode = (row[0] || '').trim();
        const op = (row[2] || '').trim();
        if (!colorCode || !op) continue;
        opStatusByColorCode[colorCode] = op;
      }
      operLoaded = true;
      updateLegendVisibility();
      refreshOperationDotsInTable();
    }

    // ✅ (A) 툴팁용 부가정보 로드 (gid=1305011805)
    async function loadExtraTooltipInfo() {
      const rows = await parseCSVFromUrl(EXTRA_INFO_CSV_URL);
      if (rows.length < 2) return;

      // V=22->21, X=24->23, AB=28->27, AD=30->29, AF=32->31
      const IDX_SIZE_ADJUST = 21; // V열: 사이즈 조절
      const IDX_TRIM        = 23; // X열: 부자재
      const IDX_MADEIN      = 27; // AB열: 제조국
      const IDX_CARELABEL   = 29; // AD열: 케어라벨
      const IDX_FEATURE     = 31; // AF열: 제품 특징

      // ⚠️ 이 시트에서 "상품코드" 열 인덱스
      const IDX_CODE = 4;

      extraInfoByProductCode = {};

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i] || [];
        if (!r.length) continue;

        const code = (r[IDX_CODE] || '').toString().trim();
        if (!code) continue;

        extraInfoByProductCode[code] = {
          sizeAdjust: (r[IDX_SIZE_ADJUST] || '').toString().trim(),
          trim:       (r[IDX_TRIM]        || '').toString().trim(),
          madeIn:     (r[IDX_MADEIN]      || '').toString().trim(),
          careLabel:  (r[IDX_CARELABEL]   || '').toString().trim(),
          feature:    (r[IDX_FEATURE]     || '').toString().trim(),
        };
      }
    }

    // ✅ (B) 미리보기 매칭용 로드 (gid=2050011179)
    async function loadPreviewMap() {
      const rows = await parseCSVFromUrl(PREVIEW_MAP_CSV_URL);
      if (rows.length < 2) return;

      // 기존 로직 그대로: AH=34->33, BL=64->63
      const IDX_CODE_AH = 33; // AH: 상품코드
      const IDX_NO_BL   = 63; // BL: 상품번호(product_no)

      productNoByCode_AH = {};
      extraRowsTextIndex = [];

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i] || [];
        if (!r.length) continue;

        const codeAH = (r[IDX_CODE_AH] || '').toString().trim();
        const productNoBL = (r[IDX_NO_BL] || '').toString().trim();

        if (codeAH && productNoBL && !productNoByCode_AH[codeAH]) {
          productNoByCode_AH[codeAH] = productNoBL;
        }

        const rowText = r.map(x => (x ?? '').toString()).join(' ').toLowerCase();
        extraRowsTextIndex.push({ text: rowText, productNo: productNoBL });
      }
    }

    // ✅✅ init: 1) 상품+재고만 먼저 → 검색창 빨리 활성화  2) 운영은 유휴시간 로드  3) 나머지는 진짜 lazy
    async function init() {
      try {
        statusEl.textContent = '상품/재고 데이터 불러오는 중...';
        keywordInput.disabled = true;

        // 1) 필수만 먼저
        await Promise.all([
          loadProducts(),
          loadStock()
        ]);

        statusEl.innerHTML = `<strong>상품 ${products.length}개</strong> (운영 정보 로딩 중...)`;
        keywordInput.disabled = false;

        // 2) 운영 상태는 유휴시간 로드 (검색 체감 우선)
        const idle = (fn) => ('requestIdleCallback' in window)
          ? requestIdleCallback(fn, { timeout: 2000 })
          : setTimeout(fn, 0);

        idle(async () => {
          try { await loadOperationStatus(); } catch {}
          // 부가정보/미리보기 매핑은 아래에서 "hover/click 시" lazy 로드
          statusEl.innerHTML = `<strong>상품 ${products.length}개</strong>`;
        });

      } catch (err) {
        console.error(err);
        statusEl.textContent = '데이터 로드 실패: ' + err.message;
        stockInfoEl.textContent = '로드 실패';
      }
    }

    // ✅ 운영 점: 운영여부 없으면 회색 점도 생성
    function buildOperationIndicator(colorCode, productCode) {
      const rawStatus = opStatusByColorCode[colorCode];

      const s = (rawStatus || '').trim();
      const normalized = s.replace(/\s+/g, '').replace(/[()]/g, '');

      let cls = 'op-status-dot ';

      if (!rawStatus) cls += 'op-status-dot--unk';
      else if (normalized.startsWith('운영')) cls += 'op-status-dot--on';
      else if (normalized.startsWith('소진후종료')) cls += 'op-status-dot--end';
      else if (normalized.startsWith('단종')) cls += 'op-status-dot--stop';
      else if (normalized.startsWith('일시중단')) cls += 'op-status-dot--pause';
      else cls += 'op-status-dot--pause';

      return `<span class="${cls}" data-product-code="${escapeHtml(productCode || '')}"></span>`;
    }

    // ✅✅ 운영 시트가 나중에 로드되더라도, 이미 렌더된 테이블 dot를 갱신
    function refreshOperationDotsInTable(){
      if (!resultEl) return;
      const dots = resultEl.querySelectorAll('.op-status-dot');
      if (!dots || !dots.length) return;

      dots.forEach(dot => {
        const cell = dot.closest('.product-name-cell');
        if (!cell) return;
        const colorCode = (cell.dataset.colorCode || '').trim();
        if (!colorCode) return;

        const rawStatus = opStatusByColorCode[colorCode];
        const s = (rawStatus || '').trim();
        const normalized = s.replace(/\s+/g, '').replace(/[()]/g, '');

        dot.classList.remove(
          'op-status-dot--on',
          'op-status-dot--end',
          'op-status-dot--stop',
          'op-status-dot--pause',
          'op-status-dot--unk'
        );

        if (!rawStatus) dot.classList.add('op-status-dot--unk');
        else if (normalized.startsWith('운영')) dot.classList.add('op-status-dot--on');
        else if (normalized.startsWith('소진후종료')) dot.classList.add('op-status-dot--end');
        else if (normalized.startsWith('단종')) dot.classList.add('op-status-dot--stop');
        else if (normalized.startsWith('일시중단')) dot.classList.add('op-status-dot--pause');
        else dot.classList.add('op-status-dot--pause');
      });

      updateLegendVisibility();
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightText(text, keyword) {
      const base = escapeHtml(text || '');
      if (!keyword) return base;

      const kw = keyword.trim();
      if (!kw) return base;

      const pattern = new RegExp(escapeRegExp(kw), 'gi');
      return base.replace(pattern, match => `<mark class="kw-mark">${match}</mark>`);
    }

    function buildHeaderCell(label, key, extraClass = '', textAlignCenter = false) {
      const isActive = sortKey === key;
      const arrow = isActive ? (sortDir === 'asc' ? '▲' : '▼') : '';
      const classes = [
        'sortable',
        isActive ? 'sortable-active' : '',
        extraClass || '',
        textAlignCenter ? 'text-center' : ''
      ].filter(Boolean).join(' ');

      return `
        <th class="${classes}" data-sort-key="${key}">
          <span class="th-label">${escapeHtml(label)}${
            arrow ? `<span class="sort-indicator">${arrow}</span>` : ''
          }</span>
          <span class="resize-handle"></span>
        </th>
      `;
    }

    function compareRows(a, b) {
      const direction = sortDir === 'desc' ? -1 : 1;
      const key = sortKey;

      function cmpString(sa, sb) {
        return sa.localeCompare(sb, 'ko-KR');
      }

      function tieBreak(a, b) {
        const nCmp = cmpString(a.productName || '', b.productName || '');
        if (nCmp !== 0) return nCmp;
        const cCmp = cmpString(a.colorName || '', b.colorName || '');
        if (cCmp !== 0) return cCmp;
        return cmpString(a.colorCode || '', b.colorCode || '');
      }

      if (key === 'stock') {
        const aNum = (typeof a.stockNum === 'number') ? a.stockNum : -1;
        const bNum = (typeof b.stockNum === 'number') ? b.stockNum : -1;
        if (aNum !== bNum) {
          return (aNum < bNum ? -1 : 1) * direction;
        }
        return tieBreak(a, b);
      }

      let valA = '';
      let valB = '';

      switch (key) {
        case 'productName': valA = a.productName || ''; valB = b.productName || ''; break;
        case 'colorName':   valA = a.colorName || '';   valB = b.colorName || '';   break;
        case 'barcode':     valA = a.barcode || '';     valB = b.barcode || '';     break;
        case 'productCode': valA = a.productCode || ''; valB = b.productCode || ''; break;
        case 'colorCode':   valA = a.colorCode || '';   valB = b.colorCode || '';   break;
        case 'size':        valA = a.size || '';        valB = b.size || '';        break;
        case 'material':    valA = a.material || '';    valB = b.material || '';    break;
        case 'warehouse':   valA = a.warehouse || '';   valB = b.warehouse || '';   break;
        default: return tieBreak(a, b);
      }

      const primary = cmpString(valA, valB);
      if (primary !== 0) return primary * direction;
      return tieBreak(a, b);
    }

    // ===========================
    // fallback(기존 유지)
    // ===========================
    const detailUrlCache = new Map();
    const CACHE_KEY = 'ws_detail_cache_v2';
    let inflightCtrl = null;

    try {
      const saved = localStorage.getItem(CACHE_KEY);
      if (saved) {
        const obj = JSON.parse(saved);
        Object.entries(obj).forEach(([k, v]) => detailUrlCache.set(k, v));
      }
    } catch {}

    function persistCache(){
      try{
        const obj = Object.fromEntries(detailUrlCache.entries());
        localStorage.setItem(CACHE_KEY, JSON.stringify(obj));
      }catch{}
    }

    function extractFirstProductHref(html){
      if (!html) return '';
      let m = html.match(/href\s*=\s*["']([^"']*product\/detail\.html\?product_no=\d+[^"']*)["']/i);
      if (m && m[1]) return decodeHtmlEntities(m[1]);
      m = html.match(/href\s*=\s*["'](\/product\/[^"']+\/\d+\/[^"']*)["']/i);
      if (m && m[1]) return decodeHtmlEntities(m[1]);
      m = html.match(/href\s*=\s*["'](\/product\/[^"']+)["']/i);
      if (m && m[1]) return decodeHtmlEntities(m[1]);
      return '';
    }

    function decodeHtmlEntities(str){
      if (!str) return '';
      const ta = document.createElement('textarea');
      ta.innerHTML = str;
      return ta.value;
    }

    async function fetchAndCacheFirstDetailUrl(keyword){
      const searchUrl = `https://whitesands.co.kr/product/search.html?keyword=${encodeURIComponent(keyword)}`;
      const proxyUrl  = `https://r.jina.ai/${searchUrl}`;

      const cached = detailUrlCache.get(keyword);
      if (cached) return cached;

      const res = await fetch(proxyUrl, {
        headers: { 'x-cache-tolerance': '21600' }
      });
      if (!res.ok) throw new Error('검색 페이지 로드 실패: ' + res.status);

      const html = await res.text();
      const firstHref = extractFirstProductHref(html);
      if (!firstHref) return '';

      const detailUrl = firstHref.startsWith('http')
        ? firstHref
        : `https://whitesands.co.kr${firstHref.startsWith('/') ? '' : '/'}${firstHref}`;

      detailUrlCache.set(keyword, detailUrl);
      persistCache();
      return detailUrl;
    }

    async function openFirstProductDetailWithFallback(candidates){
      for (const kw of candidates) {
        const cached = detailUrlCache.get(kw);
        if (cached){
          window.open(cached, '_blank', 'noopener');
          showToast(`상세(캐시)로 이동!`);
          return;
        }
      }

      if (inflightCtrl) inflightCtrl.abort();
      inflightCtrl = new AbortController();

      try{
        showToast('첫 상품 찾는 중...');

        const makeTimeoutAbort = (ms) => setTimeout(() => {
          try{ inflightCtrl?.abort(); } catch {}
        }, ms);

        for (const kw of candidates) {
          if (inflightCtrl) inflightCtrl.abort();
          inflightCtrl = new AbortController();

          const timeoutId = makeTimeoutAbort(4000);

          try {
            const url = await fetchAndCacheFirstDetailUrl(kw);
            clearTimeout(timeoutId);

            if (url) {
              window.open(url, '_blank', 'noopener');
              showToast('첫 상품 상세로 이동!');
              inflightCtrl = null;
              return;
            }
          } catch (err) {
            clearTimeout(timeoutId);
            continue;
          }
        }

        const last = candidates[candidates.length - 1];
        window.open(`https://whitesands.co.kr/product/search.html?keyword=${encodeURIComponent(last)}`, '_blank', 'noopener');
        showToast('상세를 못 찾아서 검색페이지로 열었어요.');
      } finally {
        inflightCtrl = null;
      }
    }

    function prefetchDetailUrlsFromCurrentTable(limit = 8){
      const cells = Array.from(resultEl.querySelectorAll('.product-name-cell'));
      if (!cells.length) return;

      const keys = [];
      for (const cell of cells) {
        const colorCode = (cell.dataset.colorCode || '').trim();
        if (colorCode && !productNoByColorCode[colorCode] && !detailUrlCache.get(colorCode)) keys.push(colorCode);
        if (keys.length >= limit) break;
      }
      if (!keys.length) return;

      const run = async () => {
        for (const k of keys) {
          try { await fetchAndCacheFirstDetailUrl(k); } catch {}
        }
      };

      if ('requestIdleCallback' in window) requestIdleCallback(run, { timeout: 1500 });
      else setTimeout(run, 50);
    }

    // ===========================
    // 검색
    // ===========================
    function search() {
      const kw = keywordInput.value.trim();
      lastKeyword = kw;

      if (!products.length) {
        statusEl.textContent = '데이터가 아직 로드되지 않았습니다.';
        return;
      }
      if (!kw) {
        statusEl.textContent = '검색 키워드를 입력해주세요.';
        resultEl.innerHTML = '<div class="no-result">검색 키워드를 입력한 후 다시 시도해주세요.</div>';
        if (resultInfoEl) resultInfoEl.textContent = '검색 전 입니다.';
        return;
      }

      const lowerKw = kw.toLowerCase();
      const filteredProducts = products.filter(p => {
        const name      = (p.productName || '').toLowerCase();
        const code      = (p.productCode || '').toLowerCase();
        const colorCode = (p.colorCode   || '').toLowerCase();

        return (
          name.includes(lowerKw) ||
          code.includes(lowerKw) ||
          colorCode.includes(lowerKw)
        );
      });

      if (!filteredProducts.length) {
        statusEl.textContent = `"${kw}" 검색 결과: 0개`;
        resultEl.innerHTML = '<div class="no-result">검색 결과 없음</div>';
        if (resultInfoEl) resultInfoEl.textContent = `검색어 "${kw}" 결과 0개`;
        return;
      }

      const rows = [];

      filteredProducts.forEach(p => {
        const entries = stockEntriesByColorCode[p.colorCode] || [];
        const pno = productNoByColorCode[p.colorCode] || '';

        let useEntries;
        if (showWarehouse) {
          useEntries = entries;
        } else {
          useEntries = entries.filter(e => e.warehouse === '주희물류');
        }

        if (!useEntries.length) {
          rows.push({
            productName: p.productName || '',
            colorName:   p.colorName   || '',
            barcode:     p.barcode     || '',
            productCode: p.productCode || '',
            colorCode:   p.colorCode   || '',
            size:        sizeByColorCode[p.colorCode] || '',
            material:    p.material    || '',
            warehouse:   '',
            stockNum:    null,
            stockStr:    '',
            stockClass:  '',
            rawName:     p.rawName     || '',
            colorCodeKey: p.colorCode  || '',
            productNo:   pno
          });
          return;
        }

        let sortedEntries = useEntries;
        if (showWarehouse) {
          sortedEntries = [...useEntries].sort((a, b) => {
            const aw = a.warehouse || '';
            const bw = b.warehouse || '';
            if (aw === '주희물류' && bw !== '주희물류') return -1;
            if (bw === '주희물류' && aw !== '주희물류') return 1;
            return aw.localeCompare(bw, 'ko-KR');
          });
        }

        sortedEntries.forEach(entry => {
          const stockNum = entry.qty;
          const stockStr = String(stockNum);
          let stockClass = 'stock-pill stock-pill-green';
          if (!isNaN(stockNum)) {
            if (stockNum >= 100) stockClass = 'stock-pill stock-pill-green';
            else if (stockNum >= 10) stockClass = 'stock-pill stock-pill-yellow';
            else if (stockNum >= 0) stockClass = 'stock-pill stock-pill-red';
          }

          rows.push({
            productName: p.productName || '',
            colorName:   p.colorName   || '',
            barcode:     p.barcode     || '',
            productCode: p.productCode || '',
            colorCode:   p.colorCode   || '',
            size:        entry.size || sizeByColorCode[p.colorCode] || '',
            material:    p.material    || '',
            warehouse:   showWarehouse ? (entry.warehouse || '') : '',
            stockNum,
            stockStr,
            stockClass,
            rawName:     p.rawName     || '',
            colorCodeKey: p.colorCode  || '',
            productNo:   pno
          });
        });
      });

      let usedRows = rows;
      if (inStockOnly) {
        usedRows = rows.filter(r => typeof r.stockNum === 'number' && r.stockNum > 0);
      }

      if (!usedRows.length) {
        statusEl.innerHTML = `"${kw}" 검색 결과: <strong>0행</strong> (재고 있음만 필터 적용)`;
        resultEl.innerHTML = '<div class="no-result">조건에 맞는 재고가 없습니다.</div>';
        return;
      }

      usedRows.sort(compareRows);

      statusEl.innerHTML = `"${kw}" 검색 결과: <strong>${usedRows.length}행</strong>`;

      let headerHtml = '<tr>';
      headerHtml += buildHeaderCell('상품명', 'productName', 'col-product');
      headerHtml += buildHeaderCell('칼라명', 'colorName', 'col-color');
      headerHtml += buildHeaderCell('바코드', 'barcode');
      headerHtml += buildHeaderCell('상품코드', 'productCode', 'col-pcode');
      headerHtml += buildHeaderCell('상품칼라코드', 'colorCode');
      headerHtml += buildHeaderCell('사이즈', 'size');

      if (showMaterial) headerHtml += buildHeaderCell('소재', 'material');
      if (showWarehouse) headerHtml += buildHeaderCell('창고', 'warehouse', 'col-warehouse');

      headerHtml += buildHeaderCell('재고', 'stock', 'stock-header', true);
      headerHtml += '</tr>';

      let bodyHtml = '';

      usedRows.forEach(r => {
        const opIndicatorHtml = buildOperationIndicator(r.colorCode, r.productCode);

        const rawNameEsc = escapeHtml(r.rawName || '');
        const hasRaw = r.rawName && r.rawName !== r.productName;
        const titleAttr = hasRaw ? ` title="${rawNameEsc}"` : '';

        const hasStock = r.stockStr && r.stockClass;

        const stockCellInner = hasStock ? `
          <span class="stock-cell"
                data-product-no="${escapeHtml(r.productNo || '')}"
                data-product-name="${escapeHtml(r.productName)}"
                data-product-code="${escapeHtml(r.productCode)}"
                data-color-code="${escapeHtml(r.colorCodeKey || '')}">
            <span class="${r.stockClass}">
              <span class="stock-pill-dot"></span>${escapeHtml(r.stockStr)}
            </span>
          </span>
        ` : '';

        bodyHtml += `
          <tr>
            <td class="product-name-cell col-product"${titleAttr} data-color-code="${escapeHtml(r.colorCodeKey || '')}">
              ${opIndicatorHtml}${highlightText(r.productName || '', lastKeyword)}
            </td>
            <td class="col-color">${highlightText(r.colorName || '', lastKeyword)}</td>
            <td>${highlightText(r.barcode || '', lastKeyword)}</td>
            <td class="col-pcode">${highlightText(r.productCode || '', lastKeyword)}</td>
            <td>${highlightText(r.colorCode || '', lastKeyword)}</td>
            <td>${highlightText(r.size || '', lastKeyword)}</td>
            ${showMaterial ? `<td>${highlightText(r.material || '', lastKeyword)}</td>` : ''}
            ${showWarehouse ? `<td class="col-warehouse">${highlightText(r.warehouse || '', lastKeyword)}</td>` : ''}
            <td class="text-right">${stockCellInner}</td>
          </tr>
        `;
      });

      const html = `
        <div class="result-table-wrap">
          <div class="result-scroll">
            <table>
              <thead>${headerHtml}</thead>
              <tbody>${bodyHtml}</tbody>
            </table>
          </div>
        </div>
      `;
      resultEl.innerHTML = html;

      // 운영 데이터가 이미 로드된 상태라면 dot를 정확히 반영
      if (operLoaded) refreshOperationDotsInTable();
      else updateLegendVisibility();

      attachTableHeaderEvents();
      prefetchDetailUrlsFromCurrentTable(8);
    }

    function attachTableHeaderEvents() {
      const table = resultEl.querySelector('table');
      if (!table) return;

      const thead = table.querySelector('thead');
      const ths = thead ? Array.from(thead.querySelectorAll('th')) : [];

      ths.forEach((th, index) => {
        const key = th.dataset.sortKey;

        if (key) {
          th.addEventListener('click', (e) => {
            if (e.target.classList.contains('resize-handle') || e.target.closest('.resize-handle')) return;
            if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
            else { sortKey = key; sortDir = 'asc'; }
            search();
          });
        }

        let handle = th.querySelector('.resize-handle');
        if (!handle) {
          handle = document.createElement('span');
          handle.className = 'resize-handle';
          th.appendChild(handle);
        }

        handle.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          startColumnResize(e, table, th, index);
        });
      });
    }

    function startColumnResize(e, table, th, colIndex) {
      const startX = e.pageX;
      const startWidth = th.offsetWidth;

      const bodyRows = table.tBodies[0] ? Array.from(table.tBodies[0].rows) : [];
      const thead = table.tHead;
      const headCells = thead ? Array.from(thead.rows[0].cells) : [];

      function onMouseMove(ev) {
        const dx = ev.pageX - startX;
        const newWidth = Math.max(60, startWidth + dx);

        if (headCells[colIndex]) headCells[colIndex].style.width = newWidth + 'px';
        bodyRows.forEach(row => {
          if (row.cells[colIndex]) row.cells[colIndex].style.width = newWidth + 'px';
        });
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    }

    // 엔터 검색
    keywordInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        search();
      }
    });

    // 칩 토글 변경 시 바로 재검색 (키워드 있을 때만)
    toggleMaterialInput.addEventListener('change', () => {
      showMaterial = toggleMaterialInput.checked;
      if (keywordInput.value.trim()) search();
    });
    toggleWarehouseInput.addEventListener('change', () => {
      showWarehouse = toggleWarehouseInput.checked;
      if (keywordInput.value.trim()) search();
    });
    toggleInStockOnlyInput.addEventListener('change', () => {
      inStockOnly = toggleInStockOnlyInput.checked;
      if (keywordInput.value.trim()) search();
    });

    // 상품명 클릭 → 원래 상품명 복사 (단, 운영 점 클릭은 제외)
    resultEl.addEventListener('click', e => {
      if (e.target.closest('.op-status-dot')) return;

      const cell = e.target.closest('.product-name-cell');
      if (!cell) return;

      const colorCode = cell.dataset.colorCode;
      if (!colorCode) return;

      const prod = products.find(p => p.colorCode === colorCode);
      if (!prod || !prod.rawName) return;

      const textToCopy = prod.rawName;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy)
          .then(() => showToast('원래 상품명을 복사했어요.'))
          .catch(() => showToast('복사에 실패했어요. 브라우저 권한을 확인해주세요.'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = textToCopy;
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showToast('원래 상품명을 복사했어요.');
        } catch (err) {
          showToast('복사에 실패했어요.');
        }
        document.body.removeChild(ta);
      }
    });

    // 타이틀 클릭 → 사이트 검색 페이지
    document.addEventListener('DOMContentLoaded', () => {
      const titleEl = document.querySelector('.title-wrap h1');
      if (titleEl) {
        titleEl.addEventListener('click', () => {
          window.open('https://whitesands.co.kr/product/search.html?keyword=', '_blank', 'noopener');
        });
      }
    });

    // ✅✅ 재고 pill 클릭 → 상품번호(product_no) 찾기 우선순위
    // 0) 재고시트 J열(productNoByColorCode) -> 이미 data-product-no에 들어옴
    // 1) 미리보기 매칭 시트(AH->BL) productCode -> productNo
    // 2) 키워드 포함 검색(미리보기 매칭 시트 행 전체 텍스트) -> productNo
    // 3) 기존 fallback(느림)
    function findProductNoByKeywordFallback(keyword){
      const kw = (keyword || '').toString().trim().toLowerCase();
      if (!kw) return '';
      if (kw.length < 2) return '';

      for (const row of extraRowsTextIndex) {
        if (row.text.includes(kw)) {
          const pno = normalizeProductNo(row.productNo);
          if (pno) return pno;
        }
      }
      return '';
    }

    document.addEventListener("click", async (e) => {
      const cell = e.target.closest(".stock-cell");
      if (!cell) return;

      // ✅ 미리보기 매핑은 "클릭할 때" lazy 로드
      if (!previewMapLoaded) {
        previewMapLoaded = true;
        try { await loadPreviewMap(); } catch {}
      }

      // 0) 재고 시트 product_no
      let productNo = normalizeProductNo((cell.dataset.productNo || "").trim());

      // 1) AH -> BL (미리보기 매칭 시트)
      if (!productNo) {
        const productCode = (cell.dataset.productCode || "").trim();
        const mapped = productCode ? productNoByCode_AH[productCode] : '';
        productNo = normalizeProductNo(mapped);
      }

      // 2) 키워드 포함 검색 -> BL
      if (!productNo) {
        productNo = findProductNoByKeywordFallback(keywordInput.value);
      }

      if (productNo) {
        openPreviewByProductNo(productNo);
        return;
      }

      // 3) 기존 fallback
      const colorCode   = (cell.dataset.colorCode || "").trim();
      const productCode = (cell.dataset.productCode || "").trim();
      const productName = (cell.dataset.productName || "").trim();

      const candidates = [colorCode, productCode, productName].filter(Boolean);
      if (!candidates.length) return;

      await openFirstProductDetailWithFallback(candidates);
    });

    // 단축키: Ctrl+K / Cmd+K / /
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')) {
        e.preventDefault();
        keywordInput.focus();
        keywordInput.select();
        return;
      }
      if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
        const tag = document.activeElement && document.activeElement.tagName;
        if (tag !== 'INPUT' && tag !== 'TEXTAREA') {
          e.preventDefault();
          keywordInput.focus();
          keywordInput.select();
        }
      }
    });

    // 검색어 X 버튼
    function updateClearBtn(){
      if (!clearBtn) return;
      clearBtn.style.display = keywordInput.value.trim() ? 'inline-flex' : 'none';
    }
    keywordInput.addEventListener('input', updateClearBtn);
    clearBtn.addEventListener('click', () => {
      keywordInput.value = '';
      updateClearBtn();
      keywordInput.focus();
      statusEl.textContent = '검색 키워드를 입력해주세요.';
      resultEl.innerHTML = '<div class="no-result">검색 키워드를 입력한 후 다시 시도해주세요.</div>';
    });

    function syncPillActiveByInput(inputEl){
      const label = inputEl.closest('.type-pill');
      if (!label) return;
      label.classList.toggle('active', inputEl.checked);
    }
    [ toggleWarehouseInput, toggleMaterialInput, toggleInStockOnlyInput ].forEach(inp => {
      if (!inp) return;
      syncPillActiveByInput(inp);
      inp.addEventListener('change', () => syncPillActiveByInput(inp));
    });

    // ===========================
    // 운영 점 Hover → 부가정보 툴팁 (예쁜 UI)
    // ===========================
    function showExtraTooltip(x, y, html){
      if (!extraTooltipEl) return;
      extraTooltipEl.innerHTML = html;
      extraTooltipEl.style.display = 'block';
      extraTooltipEl.setAttribute('aria-hidden', 'false');

      const pad = 12;
      const rect = extraTooltipEl.getBoundingClientRect();
      let left = x + 14;
      let top  = y + 14;

      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if (left + rect.width + pad > vw) left = x - rect.width - 14;
      if (top + rect.height + pad > vh) top = y - rect.height - 14;

      extraTooltipEl.style.left = `${Math.max(pad, left)}px`;
      extraTooltipEl.style.top  = `${Math.max(pad, top)}px`;
    }

    function hideExtraTooltip(){
      if (!extraTooltipEl) return;
      extraTooltipEl.style.display = 'none';
      extraTooltipEl.setAttribute('aria-hidden', 'true');
      extraTooltipEl.innerHTML = '';
    }

    function buildExtraTooltipHTML(productCode, info){
      const safe = info || {};
      const html = `
        <div class="t-title">
          <span>부가정보</span>
          <span class="badge">${escapeHtml(productCode || 'NO-CODE')}</span>
        </div>
        <div class="t-list">
          <div class="t-item"><div class="t-k">사이즈조절</div><div class="t-v">${escapeHtml(safe.sizeAdjust || '정보 없음')}</div></div>
          <div class="t-item"><div class="t-k">부자재</div><div class="t-v">${escapeHtml(safe.trim || '정보 없음')}</div></div>
          <div class="t-item"><div class="t-k">제조국</div><div class="t-v">${escapeHtml(safe.madeIn || '정보 없음')}</div></div>
          <div class="t-item"><div class="t-k">케어라벨</div><div class="t-v">${escapeHtml(safe.careLabel || '정보 없음')}</div></div>
          <div class="t-item"><div class="t-k">제품특징</div><div class="t-v">${escapeHtml(safe.feature || '정보 없음')}</div></div>
        </div>
        <div class="t-hint">※ 운영 점(●) 위에 올리면 표시됩니다</div>
      `;
      return html;
    }

    let activeDot = null;

    document.addEventListener('mousemove', async (e) => {
      const dot = e.target.closest('.op-status-dot');

      if (!dot) {
        if (activeDot) {
          activeDot = null;
          hideExtraTooltip();
        }
        return;
      }

      // ✅ 부가정보는 hover할 때 lazy 로드
      if (!extraInfoLoaded) {
        extraInfoLoaded = true;
        try { await loadExtraTooltipInfo(); } catch {}
      }

      const code = (dot.dataset.productCode || '').trim();
      const info = code ? extraInfoByProductCode[code] : null;

      if (activeDot !== dot || extraTooltipEl.style.display !== 'block') {
        activeDot = dot;
        const html = buildExtraTooltipHTML(code, info);
        showExtraTooltip(e.clientX, e.clientY, html);
      } else {
        // 위치만 따라가기
        const rect = extraTooltipEl.getBoundingClientRect();
        const pad = 12;
        let left = e.clientX + 14;
        let top  = e.clientY + 14;
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        if (left + rect.width + pad > vw) left = e.clientX - rect.width - 14;
        if (top + rect.height + pad > vh) top = e.clientY - rect.height - 14;

        extraTooltipEl.style.left = `${Math.max(pad, left)}px`;
        extraTooltipEl.style.top  = `${Math.max(pad, top)}px`;
      }
    });

    window.addEventListener('scroll', () => { activeDot = null; hideExtraTooltip(); }, { passive: true });
    window.addEventListener('resize', () => { activeDot = null; hideExtraTooltip(); });

    // ===========================
    // 드래그 복사: 바코드/상품코드/상품칼라코드 → TSV로 클립보드 변환
    // (Google Sheets에 붙여넣으면 A/C/E에 들어가게: B,D는 빈칸)
    // ===========================
    function isInsideResultTable(sel){
      if(!sel) return false;
      const node = sel.anchorNode || sel.focusNode;
      const el = node?.nodeType === 1 ? node : node?.parentElement;
      return !!el?.closest?.('#result table');
    }

    function getSelectedText(){
      const sel = window.getSelection();
      if(!sel) return "";
      return sel.toString();
    }

    function selectionToTSV(selectedText){
      const s = (selectedText || "")
        .replace(/\r\n/g, "\n")
        .replace(/[ \t]+\n/g, "\n")
        .trim();

      if(!s) return "";

      const tokens = s
        .split(/\t|\n/g)
        .map(x => x.replace(/\s+/g, " ").trim());

      const barcode   = tokens[0] ?? "";
      const prodCode  = tokens[1] ?? "";
      const colorCode = tokens[2] ?? "";

      // ✅ A=바코드, C=상품코드, E=상품컬러코드 (B,D는 빈칸)
      return `${barcode}\t\t${prodCode}\t\t${colorCode}`;
    }

    document.addEventListener("copy", (e) => {
      const sel = window.getSelection();
      if(!sel || sel.isCollapsed) return;
      if(!isInsideResultTable(sel)) return;

      const raw = getSelectedText();
      const tsv = selectionToTSV(raw);
      if(!tsv) return;

      e.preventDefault();
      e.clipboardData.setData("text/plain", tsv);
    });

    // ===========================
  // ✅ 위젯에서 ?q= 로 들어오면 자동으로 검색 실행
  // ===========================
  const URL_QS_KEY = "q"; // 어드민 위젯이 쓰는 키와 동일해야 함

  function getInitialQueryFromUrl() {
    try {
      const u = new URL(location.href);
      return (u.searchParams.get(URL_QS_KEY) || "").trim();
    } catch {
      return "";
    }
  }

  // init() 보다 먼저 읽어두기
  const __initialQuery = getInitialQueryFromUrl();

  // ✅ keywordInput/clearBtn가 이미 선언된 상태(너 코드 구조상 그럼)에서 값 주입
  if (typeof keywordInput !== "undefined" && keywordInput && __initialQuery) {
    keywordInput.value = __initialQuery;

    // X 버튼 표시 갱신(너 코드에 있는 함수)
    try { updateClearBtn(); } catch {}
  }

  // ✅ init() 끝나고(데이터 로드 후) 자동 검색
  const __origInit = init;
  init = async function () {
    await __origInit();

    // 데이터 로드 끝나서 입력 활성화된 뒤 실행
    if (__initialQuery && keywordInput && !keywordInput.disabled) {
      try { search(); } catch {}
    }
  };
// ✅ embed=1 이면 iframe용(검색창 숨김) 모드
(function(){
  try{
    const u = new URL(location.href);
    const isEmbed = u.searchParams.get("embed") === "1";
    if(isEmbed) document.body.classList.add("embed");
  }catch{}
})();

    

    init();
  </script>
</body>
</html>

