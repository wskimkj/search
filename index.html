<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒí’ˆ ì¡°íšŒ</title>

  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" type="image/png" href="android-chrome-512x512 (1).ico">

  <!-- í°íŠ¸ -->
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">

  <!-- CSV íŒŒì„œ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top left, #f9a8d4 0, #e5e7eb 40%, #e0f2fe 100%);
      --card-bg: rgba(255, 255, 255, 0.96);
      --accent: #f472b6;
      --accent-soft: #fb7185;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --radius-xl: 18px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.18);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 24px;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      background: var(--card-bg);
      border-radius: 28px;
      box-shadow: var(--shadow-soft), 0 0 0 1px rgba(255, 255, 255, 0.7);
      padding: 22px 24px 26px;
      position: relative;
      overflow: hidden;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(244, 114, 182, 0.15), transparent 70%);
      top: -120px;
      right: -80px;
      pointer-events: none;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
      position: relative;
      z-index: 1;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-pill {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f9a8d4, #f97316);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      box-shadow: 0 8px 18px rgba(248, 113, 113, 0.4);
    }

    .title-wrap h1 {
      margin: 0;
      font-size: 19px;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-tag {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid rgba(248, 113, 113, 0.4);
    }

    .title-wrap p {
      margin: 3px 0 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-right {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .header-right span {
      font-weight: 600;
      color: #0f766e;
    }

    .pill-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }

    .content-row {
      display: grid;
      grid-template-columns: minmax(0, 0.7fr) minmax(0, 2.3fr);
      gap: 16px;
      align-items: flex-start;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 860px) {
      body { padding: 12px; }
      .app-shell { border-radius: 20px; padding: 16px; }
      .content-row { grid-template-columns: minmax(0, 1fr); }
      .header { flex-direction: column; align-items: flex-start; }
      .header-right { text-align: left; }
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-xl);
      padding: 14px 14px 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    .card-title {
      font-size: 13px;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-title span.icon { font-size: 15px; }

    .card-sub {
      font-size: 11px;
      margin: 0 0 10px;
      color: var(--text-muted);
    }

    .search-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .input-wrap { position: relative; }

    .input-wrap input[type="text"] {
      width: 100%;
      padding: 9px 36px 9px 32px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      outline: none;
      background: #f9fafb;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }
    .input-wrap input::placeholder {
      color: #9ca3af;
      font-size: 12px;
    }
    .input-wrap input:focus {
      background: #ffffff;
      border-color: #fb7185;
      box-shadow: 0 0 0 1px rgba(251, 113, 133, 0.55), 0 10px 25px rgba(248, 113, 113, 0.18);
    }
    .input-icon-left {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #9ca3af;
    }
    .input-icon-right {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: #9ca3af;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px 12px;
      margin-top: 4px;
    }

    button#searchBtn {
      padding: 7px 16px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #f472b6, #fb7185);
      color: white;
      font-weight: 500;
      box-shadow: 0 10px 25px rgba(248, 113, 113, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }
    button#searchBtn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(248, 113, 113, 0.45);
    }
    button#searchBtn:active:not(:disabled) {
      transform: translateY(0px) scale(0.99);
      box-shadow: 0 8px 18px rgba(248, 113, 113, 0.3);
    }
    button#searchBtn:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }
    .btn-icon { font-size: 14px; }

    .status {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .status strong { color: #4b5563; }

    .result-card {
      max-height: 620px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .result-table-wrap {
      margin-top: 10px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
    }

    .result-scroll {
      max-height: 520px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: #ffffff;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td { background: #fdf2f8; }
    tr:hover td { background: #fce7f3; }

    .no-result {
      margin-top: 12px;
      font-size: 12px;
      color: #9ca3af;
    }

    .text-right { text-align: right; }

    .stock-header {
      text-align: center;
    }

    /* ê²°ê³¼ ë°ì´í„° í°íŠ¸ë§Œ 1ë‹¨ê³„ ì¤„ì´ê¸° */
    .result-table-wrap td {
      font-size: 12px !important;
    }

    /* ì¬ê³  pill ê³µí†µ */
    .stock-pill {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid transparent;
    }
    .stock-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    /* ì´ˆë¡ (100 ì´ìƒ) */
    .stock-pill-green {
      background: #ecfdf3;
      color: #166534;
      border-color: rgba(34, 197, 94, 0.45);
    }
    .stock-pill-green .stock-pill-dot {
      background: #22c55e;
    }
    /* ë…¸ë‘ (10~99) */
    .stock-pill-yellow {
      background: #fef9c3;
      color: #854d0e;
      border-color: rgba(250, 204, 21, 0.7);
    }
    .stock-pill-yellow .stock-pill-dot {
      background: #facc15;
    }
    /* ë¹¨ê°• (0~9) */
    .stock-pill-red {
      background: #fee2e2;
      color: #b91c1c;
      border-color: rgba(239, 68, 68, 0.7);
    }
    .stock-pill-red .stock-pill-dot {
      background: #ef4444;
    }

    /* ìš´ì˜ ì—¬ë¶€ pill - ê¸€ì ì—†ëŠ” ì´ˆë¯¸ë‹ˆ ë¼ë²¨ */
    .op-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 1px 4px;
      border-radius: 999px;
      font-size: 9px;
      margin-right: 4px;
      border: 1px solid transparent;
      vertical-align: middle;
      white-space: nowrap;
      min-width: 0;
    }
    .op-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .op-icon {
      font-size: 9px;
      line-height: 1;
      margin-left: 2px;
    }
    .op-pill-green {
      background: #ecfdf3;
      border-color: rgba(34, 197, 94, 0.45);
    }
    .op-pill-green .op-dot {
      background: #22c55e;
    }
    .op-pill-red {
      background: #fee2e2;
      border-color: rgba(239, 68, 68, 0.7);
    }
    .op-pill-red .op-dot {
      background: #ef4444;
    }
    .op-pill-orange {
      background: #fff7ed;
      border-color: rgba(249, 115, 22, 0.7);
    }
    .op-pill-orange .op-dot {
      background: #f97316;
    }
    .op-pill-pause {
      background: #fef9c3;
      border-color: rgba(250, 204, 21, 0.7);
    }
    .op-pill-pause .op-dot {
      background: #eab308;
    }

    /* ìƒí’ˆëª… ì…€ - í´ë¦­ ê°€ëŠ¥ ëŠë‚Œ ì‚´ì§ */
    .product-name-cell {
      cursor: pointer;
    }

    /* ì›ìƒí’ˆëª… ë³µì‚¬ í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.92);
      color: #f9fafb;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 9999;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- í—¤ë” -->
    <div class="header">
      <div class="header-left">
        <div class="logo-pill">ğŸ§¸</div>
        <div class="title-wrap">
          <h1>
            ìƒí’ˆ ì¡°íšŒ
            <span class="title-tag">Google Sheets ì—°ë™</span>
          </h1>
          <p>ìƒí’ˆ ì •ë³´ + ì¬ê³ ë¥¼ í•œëˆˆì— ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬í–ˆì–´ìš”.</p>
        </div>
      </div>
      <div class="header-right">
        <div class="pill-label">
          <span class="pill-dot"></span>
          ìµœê·¼ ì—…ë°ì´íŠ¸ ê¸°ë°˜
        </div>
        <div style="margin-top: 6px;">
          ì¬ê³  ê¸°ì¤€ì¼ì‹œ<br>
          <span id="stockInfo">ë¡œë”© ì¤‘...</span>
        </div>
      </div>
    </div>

    <!-- ë³¸ë¬¸ -->
    <div class="content-row">
      <!-- ê²€ìƒ‰ ì¹´ë“œ -->
      <div class="card">
        <h2 class="card-title">
          <span class="icon">ğŸ”</span>
          ìƒí’ˆëª… ê²€ìƒ‰
        </h2>
        <p class="card-sub">
          ìƒí’ˆëª…ì— í¬í•¨ëœ ë‹¨ì–´ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆì–´ìš”.
        </p>

        <div class="search-box">
          <div class="input-wrap">
            <span class="input-icon-left">âŒ¨ï¸</span>
            <input type="text" id="keyword" placeholder="(ì˜ˆ: ë³¼ë“œë¦°, ë²¨ë£¨ì˜¤ ë“±)" />
            <span class="input-icon-right">Enter â†µ</span>
          </div>

          <div class="button-row">
            <button id="searchBtn" disabled>
              <span class="btn-icon">âœ¨</span>
              ê²€ìƒ‰í•˜ê¸°
            </button>

            <!-- ì†Œì¬ ë³´ê¸° í† ê¸€ -->
            <label style="display:inline-flex; align-items:center; gap:4px; cursor:pointer; font-size:11px;">
              <input type="checkbox" id="toggleMaterial" style="transform:scale(0.9);" />
              ì†Œì¬
            </label>

            <!-- ìš´ì˜ ì—¬ë¶€ í† ê¸€ -->
            <label style="display:inline-flex; align-items:center; gap:4px; cursor:pointer; font-size:11px;">
              <input type="checkbox" id="toggleOperation" style="transform:scale(0.9);" checked />
              ìš´ì˜
            </label>
          </div>

          <div class="status" id="status">
            ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>

      <!-- ê²°ê³¼ ì¹´ë“œ -->
      <div class="card result-card">
        <h2 class="card-title">
          <span class="icon">ğŸ“‹</span>
          ê²€ìƒ‰ ê²°ê³¼
        </h2>
        <p class="card-sub"></p>
        <div id="result">
          <div class="no-result">ì•„ì§ ê²€ìƒ‰ ì „ì´ì—ìš”. í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  <strong>ê²€ìƒ‰í•˜ê¸°</strong>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì›ìƒí’ˆëª… ë³µì‚¬ í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast">ì›ë˜ ìƒí’ˆëª…ì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”.</div>

  <script>
    // ===== 1. ì‹œíŠ¸ ì„¤ì • =====

    // ìƒí’ˆ ë§ˆìŠ¤í„° ì‹œíŠ¸
    const PRODUCT_SHEET_ID = '1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc';
    const PRODUCT_GID = '885700988';

    // ì¬ê³  ì‹œíŠ¸
    const STOCK_SHEET_ID = '1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM';
    const STOCK_GID = '366983013';

    // ìš´ì˜ ì—¬ë¶€ ì‹œíŠ¸
    const OPER_SHEET_ID = '1F4EC5w1VPmFpwSbw0LuIv5QkwSSs8YkCBPZKY3h-z64';
    const OPER_GID = '2108422262';

    const PRODUCT_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${PRODUCT_SHEET_ID}/export?format=csv&gid=${PRODUCT_GID}`;
    const STOCK_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${STOCK_SHEET_ID}/export?format=csv&gid=${STOCK_GID}`;
    const OPER_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${OPER_SHEET_ID}/export?format=csv&gid=${OPER_GID}`;

    // ===== 2. ì „ì—­ ë°ì´í„° =====
    let products = [];             // ìƒí’ˆ ëª©ë¡ (ì›ë³¸ + ì •ì œëª…)
    let stockByColorCode = {};     // { ìƒí’ˆì¹¼ë¼ì½”ë“œ: ì¬ê³ ìˆ˜ëŸ‰ }
    let sizeByColorCode = {};      // { ìƒí’ˆì¹¼ë¼ì½”ë“œ: ì‚¬ì´ì¦ˆ }
    let stockUpdatedAt = '';       // ì¬ê³  ê¸°ì¤€ì¼ì‹œ (B1)
    let showMaterial = false;      // ì†Œì¬ í‘œì‹œ ì—¬ë¶€
    let showOperation = true;      // ìš´ì˜ ì—¬ë¶€ í‘œì‹œ (ê¸°ë³¸ ON)
    let opStatusByColorCode = {};  // { ìƒí’ˆì¹¼ë¼ì½”ë“œ: ìš´ì˜ìœ ë¬´ }

    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const stockInfoEl = document.getElementById('stockInfo');
    const searchBtn = document.getElementById('searchBtn');
    const keywordInput = document.getElementById('keyword');
    const toggleMaterialInput = document.getElementById('toggleMaterial');
    const toggleOperationInput = document.getElementById('toggleOperation');
    const toastEl = document.getElementById('toast');

    toggleOperationInput.checked = true;

    // ===== 3. ìœ í‹¸ =====

    const regexBracket = /\[[^\]]*\]/g;
    const regexSeason  = /^\s*[0-9]{2}\s*(FW|SS)\s*/i;

    function cleanProductName(name) {
      if (!name) return '';
      return String(name)
        .replace(/[\r\n]+/g, '')
        .replace(/\u00A0/g, ' ')
        .replace(regexBracket, '')
        .replace(regexSeason, '')
        .replace(/\([^)]*\)\s*$/, "")
        .replace(/\s{2,}/g, ' ')
        .trim();
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function parseCSV(text) {
      const parsed = Papa.parse(text, {
        header: false,
        skipEmptyLines: true
      });
      return parsed.data;
    }

    function showToast(msg) {
      if (!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => {
        toastEl.classList.remove('show');
      }, 1400);
    }

    // ===== 4. ìƒí’ˆ ì‹œíŠ¸ ë¡œë“œ =====
    async function loadProducts() {
      const res = await fetch(PRODUCT_CSV_URL);
      if (!res.ok) {
        throw new Error('ìƒí’ˆ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + res.status);
      }
      const text = await res.text();
      const rows = parseCSV(text);
      if (rows.length < 2) return;

      // A=0 B=1 C=2 D=3 E=4 F=5 G=6 ... P=15 ... U=20 ... W=22 ... Z=25
      const idxProductCode = 5;   // Fì—´
      const idxColorName   = 15;  // Pì—´
      const idxBarcode     = 20;  // Uì—´
      const idxMaterial    = 22;  // Wì—´
      const idxColorCode   = 25;  // Zì—´
      const idxProductName = 6;   // Gì—´

      products = rows.slice(1).map(row => {
        const rawName = row[idxProductName] || '';
        const cleanedName = cleanProductName(rawName);

        return {
          productCode: row[idxProductCode] || '',
          colorName:   row[idxColorName]   || '',
          barcode:     row[idxBarcode]     || '',
          material:    row[idxMaterial]    || '',
          colorCode:   row[idxColorCode]   || '',
          rawName,
          productName: cleanedName
        };
      }).filter(p => p.productName);
    }

    // ===== 5. ì¬ê³  ì‹œíŠ¸ ë¡œë“œ =====
    async function loadStock() {
      const res = await fetch(STOCK_CSV_URL);
      if (!res.ok) {
        throw new Error('ì¬ê³  ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + res.status);
      }
      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length) return;

      stockUpdatedAt = (rows[0][1] || '').trim(); // B1
      stockInfoEl.textContent = stockUpdatedAt || 'ë¯¸ê¸°ì¬';

      // A: colorCode(0), B: size(1), K: stock(10)
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const colorCode = (row[0] || '').trim();
        if (!colorCode) continue;

        const size = (row[1] || '').trim();
        const stockQty = (row[10] || '').trim();

        sizeByColorCode[colorCode]  = size;
        stockByColorCode[colorCode] = stockQty || '0';
      }
    }

    // ===== 6. ìš´ì˜ ì—¬ë¶€ ì‹œíŠ¸ ë¡œë“œ =====
    async function loadOperationStatus() {
      const res = await fetch(OPER_CSV_URL);
      if (!res.ok) {
        console.log('ìš´ì˜ ì—¬ë¶€ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ ìƒíƒœì½”ë“œ:', res.status);
        return;
      }
      const text = await res.text();
      const rows = parseCSV(text);
      if (rows.length < 2) return;

      // Aì—´ index 0, Cì—´ index 2
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const colorCode = (row[0] || '').trim();
        const op = (row[2] || '').trim();
        if (!colorCode || !op) continue;
        opStatusByColorCode[colorCode] = op;
      }

      console.log('ìš´ì˜ ì—¬ë¶€ ë¡œë“œëœ ê±´ìˆ˜:', Object.keys(opStatusByColorCode).length);
    }

    // ===== 7. ì´ˆê¸°í™” =====
    async function init() {
      try {
        statusEl.textContent = 'ìƒí’ˆ/ì¬ê³  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        searchBtn.disabled = true;

        await Promise.all([
          loadProducts(),
          loadStock(),
          loadOperationStatus()
        ]);

        statusEl.innerHTML = `ë°ì´í„° ë¡œë“œ ì™„ë£Œ. <strong>ìƒí’ˆ ${products.length}ê°œ</strong>`;
        searchBtn.disabled = false;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
        stockInfoEl.textContent = 'ë¡œë“œ ì‹¤íŒ¨';
      }
    }

    // ===== 8. ìš´ì˜ ì—¬ë¶€ pill HTML ìƒì„± (ê¸€ì ì—†ì´ ì /ì•„ì´ì½˜ë§Œ) =====
    function buildOperationPill(colorCode) {
      if (!showOperation) return '';

      const rawStatus = opStatusByColorCode[colorCode];
      if (!rawStatus) return '';

      const s = rawStatus.trim();
      const normalized = s
        .replace(/\s+/g, '')
        .replace(/[()]/g, '');

      let cls = 'op-pill';
      let icon = '';

      if (normalized.startsWith('ìš´ì˜')) {
        cls += ' op-pill-green';
      } else if (normalized.startsWith('ì†Œì§„í›„ì¢…ë£Œ')) {
        cls += ' op-pill-orange';
      } else if (normalized.startsWith('ë‹¨ì¢…')) {
        cls += ' op-pill-red';
      } else if (normalized.startsWith('ì¼ì‹œì¤‘ë‹¨')) {
        cls += ' op-pill-pause';
        icon = 'â¸';
      } else {
        cls += ' op-pill-pause';
      }

      return `
        <span class="${cls}" title="${escapeHtml(rawStatus)}">
          <span class="op-dot"></span>
          ${icon ? `<span class="op-icon">${icon}</span>` : ''}
        </span>
      `;
    }

    // ===== 9. ê²€ìƒ‰ =====
    function search() {
      const kw = keywordInput.value.trim();
      if (!products.length) {
        statusEl.textContent = 'ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
        return;
      }
      if (!kw) {
        statusEl.textContent = 'ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        resultEl.innerHTML = '<div class="no-result">ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
        return;
      }

      const lowerKw = kw.toLowerCase();
      const filtered = products.filter(p =>
        String(p.productName).toLowerCase().includes(lowerKw)
      );

      if (!filtered.length) {
        statusEl.textContent = `"${kw}" ê²€ìƒ‰ ê²°ê³¼: 0ê°œ`;
        resultEl.innerHTML = '<div class="no-result">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
        return;
      }

      statusEl.innerHTML = `"${kw}" ê²€ìƒ‰ ê²°ê³¼: <strong>${filtered.length}ê°œ</strong>`;

      let headerHtml = `
        <tr>
          <th>ìƒí’ˆëª…</th>
          <th>ì¹¼ë¼ëª…</th>
          <th>ë°”ì½”ë“œ</th>
          <th>ìƒí’ˆì½”ë“œ</th>
          <th>ìƒí’ˆì¹¼ë¼ì½”ë“œ</th>
          <th>ì‚¬ì´ì¦ˆ</th>
      `;
      if (showMaterial) {
        headerHtml += `<th>ì†Œì¬</th>`;
      }
      headerHtml += `<th class="stock-header">ì¬ê³ </th></tr>`;

      let bodyHtml = '';

      filtered.forEach(p => {
        const stock = stockByColorCode[p.colorCode] ?? '';
        const size  = sizeByColorCode[p.colorCode] ?? '';

        const displayName = escapeHtml(p.productName || '');
        const rawName     = p.rawName || '';
        const rawNameEsc  = escapeHtml(rawName);
        const hasRaw      = rawName && rawName !== p.productName;

        const titleAttr = hasRaw ? ` title="${rawNameEsc}"` : '';
        const dataCodeAttr = p.colorCode ? ` data-color-code="${escapeHtml(p.colorCode)}"` : '';

        let stockClass = 'stock-pill stock-pill-green';
        const stockNum = Number(stock);
        if (!isNaN(stockNum)) {
          if (stockNum >= 100) {
            stockClass = 'stock-pill stock-pill-green';
          } else if (stockNum >= 10) {
            stockClass = 'stock-pill stock-pill-yellow';
          } else if (stockNum >= 0) {
            stockClass = 'stock-pill stock-pill-red';
          }
        }

        const opPillHtml = buildOperationPill(p.colorCode);

        bodyHtml += `
          <tr>
            <td class="product-name-cell"${titleAttr}${dataCodeAttr}>${opPillHtml}${displayName}</td>
            <td>${escapeHtml(p.colorName || '')}</td>
            <td>${escapeHtml(p.barcode || '')}</td>
            <td>${escapeHtml(p.productCode || '')}</td>
            <td>${escapeHtml(p.colorCode || '')}</td>
            <td>${escapeHtml(size || '')}</td>
        `;

        if (showMaterial) {
          bodyHtml += `<td>${escapeHtml(p.material || '')}</td>`;
        }

        bodyHtml += `
            <td class="text-right">
              ${stock !== ''
                ? `<span class="${stockClass}">
                     <span class="stock-pill-dot"></span>${escapeHtml(stock)}
                   </span>`
                : ''}
            </td>
          </tr>
        `;
      });

      const html = `
        <div class="result-table-wrap">
          <div class="result-scroll">
            <table>
              <thead>${headerHtml}</thead>
              <tbody>${bodyHtml}</tbody>
            </table>
          </div>
        </div>
      `;

      resultEl.innerHTML = html;
    }

    // ===== 10. ì´ë²¤íŠ¸ =====
    searchBtn.addEventListener('click', search);
    keywordInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') search();
    });

    toggleMaterialInput.addEventListener('change', () => {
      showMaterial = toggleMaterialInput.checked;
      if (keywordInput.value.trim()) {
        search();
      }
    });

    toggleOperationInput.addEventListener('change', () => {
      showOperation = toggleOperationInput.checked;
      if (keywordInput.value.trim()) {
        search();
      }
    });

    // ìƒí’ˆëª… í´ë¦­ -> ì›ë˜ ìƒí’ˆëª… í´ë¦½ë³´ë“œ ë³µì‚¬
    resultEl.addEventListener('click', e => {
      const cell = e.target.closest('.product-name-cell');
      if (!cell) return;

      const colorCode = cell.dataset.colorCode;
      if (!colorCode) return;

      const prod = products.find(p => p.colorCode === colorCode);
      if (!prod || !prod.rawName) return;

      const textToCopy = prod.rawName;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            showToast('ì›ë˜ ìƒí’ˆëª…ì„ ë³µì‚¬í–ˆì–´ìš”.');
          })
          .catch(() => {
            showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          });
      } else {
        // êµ¬í˜• ë¸Œë¼ìš°ì € fallback
        const ta = document.createElement('textarea');
        ta.value = textToCopy;
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showToast('ì›ë˜ ìƒí’ˆëª…ì„ ë³µì‚¬í–ˆì–´ìš”.');
        } catch (err) {
          showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
        }
        document.body.removeChild(ta);
      }
    });

    // ì‹œì‘
    init();
  </script>
</body>
</html>
