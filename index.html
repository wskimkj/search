<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="https://wskimkj.github.io/admin/css/common.css">

  <meta charset="UTF-8">
  <title>ìƒí’ˆ ì¡°íšŒ</title>

  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" type="image/png" href="android-chrome-512x512 (1).ico">

  <!-- í°íŠ¸ -->
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">

  <!-- CSV íŒŒì„œ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

 <style>
/* ===================== Pastel Pink UI Theme (ë””ìì¸ë§Œ êµì²´ / ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ) ===================== */
/* ===================== FINAL / SAFE CSS (ë””ìì¸ë§Œ, ë ˆì´ì•„ì›ƒ ë³µêµ¬ ë²„ì „) ===================== */
:root{
  --page-bg: #f7f4ff;
  --page-bg2:#eef6ff;

  --card-bg: rgba(255,255,255,.86);
  --card-stroke: rgba(170,150,230,.22);

  --text-main: #2f2a3a;
  --text-muted: #6e6a82;

  --pink: #ff8fbc;
  --lilac:#b8a7ff;

  --radius-xl: 18px;
  --shadow-main: 0 18px 50px rgba(30,18,60,.10);
  --shadow-card: 0 10px 26px rgba(30,18,60,.08);
}

*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text-main);
  background:
    radial-gradient(900px 520px at 20% 18%, rgba(255,143,188,.25), transparent 60%),
    radial-gradient(900px 520px at 82% 24%, rgba(184,167,255,.20), transparent 58%),
    linear-gradient(180deg, var(--page-bg), var(--page-bg2));
}

/* ===== layout ===== */
.app-shell{
  min-height:100vh;
  padding:24px;
}
.inner-shell{
  max-width:1400px;
  margin:0 auto;
  background:var(--card-bg);
  border:1px solid var(--card-stroke);
  border-radius:24px;
  padding:18px 20px 20px;
  box-shadow:var(--shadow-main);
}

/* ===== header ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:14px;
}
.title-wrap h1{
  margin:0;
  font-size:20px;
  font-weight:800;
  display:flex;
  gap:10px;
  cursor:pointer;
}
.title-tag{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(255,143,188,.25);
  border:1px solid rgba(255,143,188,.35);
}
.header-right{
  font-size:12px;
  color:var(--text-muted);
}

/* ===== cards ===== */
.card{
  background:rgba(255,255,255,.9);
  border:1px solid var(--card-stroke);
  border-radius:22px;
  box-shadow:var(--shadow-card);
}

/* ===== search ===== */
.card-search{
  display:flex;
  gap:14px;
  padding:12px 14px;
}
.card-title{
  font-size:13px;
  font-weight:700;
  margin:0;
}
.search-box{flex:1;}
.input-wrap{position:relative;}
.input-wrap input{
  width:100%;
  padding:12px 42px 12px 34px;
  border-radius:999px;
  border:1px solid rgba(170,150,230,.25);
  background:#f5f3fb;
}
.input-wrap input:focus{
  outline:none;
  border-color:var(--pink);
  box-shadow:0 0 0 4px rgba(255,143,188,.18);
}
.input-icon-left{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
}
.input-icon-right{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:11px;
  color:#999;
}

/* ===== chips ===== */
.chip-group{display:flex;gap:10px;flex-wrap:wrap;}
.chip-input{display:none;}
.chip{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(170,150,230,.25);
  background:#fff;
  cursor:pointer;
}
.chip-input:checked + .chip{
  background:rgba(255,143,188,.25);
  border-color:rgba(255,143,188,.4);
}

/* ===== result header ===== */
.result-card{padding-top:14px;}
.result-header-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}
.result-header-right{
  font-size:11px;
  color:var(--text-muted);
}

/* ===== op legend (ğŸ”¥ ë³µêµ¬ í•µì‹¬) ===== */
#opLegend.op-legend{
  display:none;          /* JSê°€ ë°ì´í„° ìˆìœ¼ë©´ flexë¡œ ë³€ê²½ */
  margin:6px 0 10px;
  padding:0;
  background:none;
  border:0;
  box-shadow:none;
  gap:12px;
}
#opLegend .op-legend-item{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  color:var(--text-muted);
  padding:0;
}
#opLegend .op-legend-item::before{content:none;}
.op-legend-dot{
  width:9px;
  height:9px;
  border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 0 1px rgba(170,150,230,.25);
}
.op-legend-dot.on{background:#22c55e;}
.op-legend-dot.end{background:#f97316;}
.op-legend-dot.stop{background:#ef4444;}
.op-legend-dot.pause{background:#eab308;}

/* ===== table ===== */
.result-table-wrap{
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(170,150,230,.18);
}
.result-scroll{max-height:520px;overflow:auto;}
table{
  width:100%;
  border-collapse:collapse;
  table-layout:auto;   /* ğŸ”¥ ì–´ê¸‹ë‚¨ ë°©ì§€ */
  font-size:12px;
}
th,td{
  padding:10px 12px;
  border-bottom:1px solid rgba(170,150,230,.15);
}
th{
  background:#fff;
  position:sticky;
  top:0;
  z-index:2;
}
tr:nth-child(even) td{background:#faf9fe;}
tr:hover td{background:rgba(255,143,188,.18);}

/* ===== product cell ===== */
.product-name-cell{
  position:relative;
  padding-left:26px;
}
.op-status-dot{
  position:absolute;
  left:10px;
  top:50%;
  transform:translateY(-48%);
}

/* ===== stock pill ===== */
.stock-pill{
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.stock-pill-dot{
  width:6px;height:6px;border-radius:50%;
}
.stock-pill-green{background:#e9fbf3;}
.stock-pill-green .stock-pill-dot{background:#22c55e;}
.stock-pill-yellow{background:#fff7d6;}
.stock-pill-yellow .stock-pill-dot{background:#facc15;}
.stock-pill-red{background:#ffe4ee;}
.stock-pill-red .stock-pill-dot{background:#ff8fbc;}

/* ===== misc ===== */
.kw-mark{
  background:yellow;
  padding:0 2px;
}
#toast{
  position:fixed;
  bottom:18px;
  right:18px;
  padding:10px 12px;
  border-radius:14px;
  background:#fff;
  border:1px solid rgba(255,143,188,.35);
  opacity:0;
}
#toast.show{opacity:1;}
/* âœ… ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì ˆ(ë¦¬ì‚¬ì´ì¦ˆ) ê¸°ëŠ¥ ë³µêµ¬ */
th{
  position: sticky; /* ì´ë¯¸ ìˆì§€ë§Œ í˜¹ì‹œ ë®ì˜€ì„ê¹Œë´ */
  top: 0;
}

thead th{
  position: sticky;
  top: 0;
  z-index: 2;
}

/* ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */
thead th{
  position: sticky;
}
thead th{
  /* í•¸ë“¤ absolute ê¸°ì¤€ */
  position: sticky;
}
thead th{
  /* sticky + handleì„ ìœ„í•´ relative í•„ìš” */
  position: sticky;
}
thead th{
  /* ìµœì¢…: sticky ìœ ì§€ + relative ê°™ì´ */
  position: sticky;
}
thead th{
  /* stickyëŠ” ìœ ì§€ë˜ê³ , relativeì€ ë³„ë„ ì§€ì • */
}
thead th{ position: sticky; }
thead th{ position: sticky; }

/* ì‹¤ì œë¡œ í•„ìš”í•œ ê±´ ì´ê±° ë‘ ì¤„ */
thead th{ position: sticky; }
thead th{ position: sticky; } /* (ì¤‘ë³µì²˜ëŸ¼ ë³´ì—¬ë„ ë¬´ì‹œí•´ë„ ë¨) */

/* âœ… í•µì‹¬ */
thead th{ position: sticky; }
thead th{ z-index: 2; }
thead th{ background:#fff; }

/* ë¦¬ì‚¬ì´ì¦ˆë¥¼ ìœ„í•´ relative ì§€ì • (stickyë‘ ê°™ì´ ì¨ë„ ë¨) */
thead th{ position: sticky; }
thead th{ top:0; }
thead th{ }
thead th{}

/* ---- ì—¬ê¸°ë¶€í„° ì§„ì§œ ë³µêµ¬ ì½”ë“œ ---- */
thead th{
  position: sticky;
  top: 0;
  z-index: 2;
}
thead th{
  /* handle absolute ê¸°ì¤€ */
  position: sticky;
}
thead th{
  /* sticky ìœ ì§€í•˜ë©´ì„œ relativeë„ í•„ìš” -> wrapperê°€ ì•„ë‹ˆë¼ th ìì²´ì— relative */
  /* sticky ìš”ì†Œë„ relativeì²˜ëŸ¼ absolute ê¸°ì¤€ì´ ë©ë‹ˆë‹¤. ê·¸ë˜ë„ í™•ì‹¤íˆ í•˜ë ¤ë©´ ì•„ë˜ ì¶”ê°€ */
}
thead th{
  /* ê°€ì¥ ì•ˆì „í•œ ë°©ì‹: pseudo wrapper ì—†ì´ thì— relative ë¶€ì—¬ */
  /* (stickyì™€ ì¶©ëŒ ì—†ìŒ) */
  position: sticky;
}
thead th{}

/* â­ ìµœì¢… ê°„ë‹¨ ë²„ì „(ì´ê±°ë§Œ ìˆìœ¼ë©´ ë¨) */
thead th{
  position: sticky;
  top: 0;
  z-index: 2;
}
thead th{
  /* absolute ê¸°ì¤€ */
  position: sticky;
}
thead th{
  /* handle ìœ„ì¹˜ë¥¼ ìœ„í•´ */
  /* stickyëŠ” positionì´ë¯€ë¡œ absolute ê¸°ì¤€ì´ ë¨ */
}

/* ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
.resize-handle{
  position: absolute;
  top: 0;
  right: 0;
  width: 10px;
  height: 100%;
  cursor: col-resize;
  user-select: none;
  background: transparent;
}

/* í•¸ë“¤ ì˜ì—­ì´ ì˜ ë³´ì´ë„ë¡(ì„ íƒ) */
.resize-handle::after{
  content:"";
  position:absolute;
  top: 20%;
  bottom: 20%;
  left: 50%;
  width: 1px;
  transform: translateX(-50%);
  background: rgba(170,150,230,.35);
  opacity: 0;
  transition: opacity .15s ease;
}
th:hover .resize-handle::after{ opacity: 1; }

/* ì •ë ¬ í´ë¦­ì€ thì—ì„œ, ë¦¬ì‚¬ì´ì¦ˆëŠ” í•¸ë“¤ì—ì„œ */
th.sortable{ cursor: pointer; user-select:none; position: relative; }
th.sortable-active{ background: rgba(255,143,188,.18); }
.sort-indicator{ margin-left:4px; font-size:10px; opacity:.9; color: rgba(255,143,188,.95); }

/* ===== responsive ===== */
@media(max-width:860px){
  .header{flex-direction:column;gap:10px;}
  .card-search{flex-direction:column;}
}


</style>

</head>

<body>
  <div class="app-shell">
    <div class="inner-shell">
      <div class="header">
        <div class="header-left">
          <div class="title-wrap">
            <h1>
              ìƒí’ˆ ì¡°íšŒ
              <span class="title-tag"> PlayMD </span>
            </h1>
          </div>
        </div>
        <div class="header-right">
          <div style="margin-top: 4px;">
            <span id="stockInfo">ë¡œë”© ì¤‘...</span>
          </div>
        </div>
      </div>

      <div class="content-row">
        <!-- ê²€ìƒ‰ ì¹´ë“œ -->
        <div class="card card-search">
          <h2 class="card-title">
            <span class="icon">ğŸ”</span>
            ê²€ìƒ‰
          </h2>
          <div class="search-box">
            <div class="input-wrap">
              <span class="input-icon-left">âŒ¨ï¸</span>
              <input type="text" id="keyword" placeholder="(ì˜ˆ: ìƒí’ˆëª…, ìƒí’ˆì½”ë“œ, ì¹¼ë¼ì½”ë“œ ë“±)" />
              <span class="input-icon-right">Enter â†µ</span>
            </div>

            <!-- âœ… ì²´í¬ë°•ìŠ¤ â†’ ì¹© í† ê¸€ -->
            <div class="chip-group">
              <input class="chip-input" type="checkbox" id="warehouse">
              <label class="chip" for="warehouse">ì°½ê³ </label>

              <input class="chip-input" type="checkbox" id="material">
              <label class="chip" for="material">ì†Œì¬</label>

              <input class="chip-input" type="checkbox" id="stock">
              <label class="chip" for="stock">ì¬ê³ </label>
            </div>

            <div class="status" id="status">
              ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
          </div>
        </div>

        <!-- ê²°ê³¼ ì¹´ë“œ -->
        <div class="card result-card">
          <div class="result-header-row">
            <h2 class="card-title">
              <span class="icon">ğŸ¤</span>
              Result
            </h2>
          </div>

          <div id="opLegend" class="op-legend">
            <span class="op-legend-item">
              <span class="op-legend-dot on"></span> ìš´ì˜
            </span>
            <span class="op-legend-item">
              <span class="op-legend-dot end"></span> ì†Œì§„ í›„ ì¢…ë£Œ
            </span>
            <span class="op-legend-item">
              <span class="op-legend-dot stop"></span> ë‹¨ì¢…
            </span>
            <span class="op-legend-item">
              <span class="op-legend-dot pause"></span> ì¼ì‹œ ì¤‘ë‹¨
            </span>
          </div>

          <div id="result">
            <div class="no-result"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">ë³µì‚¬</div>

  <script>
    // ===== ì‹œíŠ¸ ì„¤ì • =====
    const PRODUCT_SHEET_ID = '1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc';
    const PRODUCT_GID = '885700988';

    const STOCK_SHEET_ID = '1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM';
    const STOCK_GID = '366983013';

    const OPER_SHEET_ID = '1F4EC5w1VPmFpwSbw0LuIv5QkwSSs8YkCBPZKY3h-z64';
    const OPER_GID = '2108422262';

    const PRODUCT_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${PRODUCT_SHEET_ID}/export?format=csv&gid=${PRODUCT_GID}`;
    const STOCK_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${STOCK_SHEET_ID}/export?format=csv&gid=${STOCK_GID}`;
    const OPER_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${OPER_SHEET_ID}/export?format=csv&gid=${OPER_GID}`;

    // ===== ì „ì—­ ë°ì´í„° =====
    let products = [];
    let stockEntriesByColorCode = {};
    let sizeByColorCode = {};
    let stockUpdatedAt = '';

    let showMaterial = false;
    let showWarehouse = false;
    let inStockOnly = false;
    let opStatusByColorCode = {};

    let sortKey = 'productName';
    let sortDir = 'asc';

    let lastKeyword = '';

    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const stockInfoEl = document.getElementById('stockInfo');

    const keywordInput = document.getElementById('keyword');

    // âœ… ì¹© í† ê¸€ input (idê°€ material/warehouse/stock ì„)
    const toggleMaterialInput = document.getElementById('material');
    const toggleWarehouseInput = document.getElementById('warehouse');
    const toggleInStockOnlyInput = document.getElementById('stock');

    const toastEl = document.getElementById('toast');
    const opLegendEl = document.getElementById('opLegend');
    const resultInfoEl = document.getElementById('resultInfo');

    const regexBracket = /\[[^\]]*\]/g;
    const regexSeason  = /^\s*[0-9]{2}\s*(FW|SS)\s*/i;

    function cleanProductName(name) {
      if (!name) return '';
      return String(name)
        .replace(/[\r\n]+/g, '')
        .replace(/\u00A0/g, ' ')
        .replace(regexBracket, '')
        .replace(regexSeason, '')
        .replace(/\s*\([^)]*\)\s*[^()]*$/, '')
        .replace(/\([^)]*\)\s*$/, '')
        .replace(/\s{2,}/g, ' ')
        .trim();
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function parseCSV(text) {
      const parsed = Papa.parse(text, {
        header: false,
        skipEmptyLines: true
      });
      return parsed.data;
    }

    function showToast(msg) {
      if (!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => {
        toastEl.classList.remove('show');
      }, 1400);
    }

    function updateLegendVisibility() {
      if (!opLegendEl) return;
      const hasData = Object.keys(opStatusByColorCode).length > 0;
      opLegendEl.style.display = hasData ? 'flex' : 'none';
    }

    async function loadProducts() {
      const res = await fetch(PRODUCT_CSV_URL);
      if (!res.ok) throw new Error('ìƒí’ˆ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + res.status);

      const text = await res.text();
      const rows = parseCSV(text);
      if (rows.length < 2) return;

      const idxProductCode = 5;
      const idxColorName   = 15;
      const idxBarcode     = 20;
      const idxMaterial    = 22;
      const idxColorCode   = 25;
      const idxProductName = 26;

      products = rows.slice(1).map(row => {
        const rawName = row[idxProductName] || '';
        const cleanedName = cleanProductName(rawName);

        return {
          productCode: row[idxProductCode] || '',
          colorName:   row[idxColorName]   || '',
          barcode:     row[idxBarcode]     || '',
          material:    row[idxMaterial]    || '',
          colorCode:   row[idxColorCode]   || '',
          rawName,
          productName: cleanedName
        };
      }).filter(p => p.productName);
    }

    async function loadStock() {
      const res = await fetch(STOCK_CSV_URL);
      if (!res.ok) throw new Error('ì¬ê³  ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + res.status);

      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length) return;

      stockUpdatedAt = (rows[0][1] || '').trim();
      stockInfoEl.textContent = stockUpdatedAt || 'ë¯¸ê¸°ì¬';

      stockEntriesByColorCode = {};
      sizeByColorCode = {};

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row.length) continue;

        const colorCode = (row[0] || '').trim();
        if (!colorCode) continue;

        const size      = (row[1] || '').trim();
        const warehouse = (row[2] || '').trim() || 'ë¯¸ì •';
        let qtyRaw      = (row[10] || '').toString().trim();
        if (!qtyRaw) continue;

        qtyRaw = qtyRaw.replace(/,/g, '');
        const qty = Number(qtyRaw);
        if (isNaN(qty)) continue;

        if (!stockEntriesByColorCode[colorCode]) {
          stockEntriesByColorCode[colorCode] = [];
        }
        stockEntriesByColorCode[colorCode].push({ warehouse, size, qty });

        if (!sizeByColorCode[colorCode] && size) {
          sizeByColorCode[colorCode] = size;
        }
      }
    }

    async function loadOperationStatus() {
      const res = await fetch(OPER_CSV_URL);
      if (!res.ok) {
        console.log('ìš´ì˜ ì—¬ë¶€ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ ìƒíƒœì½”ë“œ:', res.status);
        return;
      }
      const text = await res.text();
      const rows = parseCSV(text);
      if (rows.length < 2) return;

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const colorCode = (row[0] || '').trim();
        const op = (row[2] || '').trim();
        if (!colorCode || !op) continue;
        opStatusByColorCode[colorCode] = op;
      }
      updateLegendVisibility();
    }

    async function init() {
      try {
        statusEl.textContent = 'ìƒí’ˆ/ì¬ê³  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        keywordInput.disabled = true;

        await Promise.all([
          loadProducts(),
          loadStock(),
          loadOperationStatus()
        ]);

        statusEl.innerHTML = `<strong>ìƒí’ˆ ${products.length}ê°œ</strong>`;
        keywordInput.disabled = false;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
        stockInfoEl.textContent = 'ë¡œë“œ ì‹¤íŒ¨';
      }
    }

    function buildOperationIndicator(colorCode) {
      const rawStatus = opStatusByColorCode[colorCode];
      if (!rawStatus) return '';

      const s = rawStatus.trim();
      const normalized = s.replace(/\s+/g, '').replace(/[()]/g, '');
      let cls = 'op-status-dot ';
      if (normalized.startsWith('ìš´ì˜')) cls += 'op-status-dot--on';
      else if (normalized.startsWith('ì†Œì§„í›„ì¢…ë£Œ')) cls += 'op-status-dot--end';
      else if (normalized.startsWith('ë‹¨ì¢…')) cls += 'op-status-dot--stop';
      else if (normalized.startsWith('ì¼ì‹œì¤‘ë‹¨')) cls += 'op-status-dot--pause';
      else cls += 'op-status-dot--pause';

      return `<span class="${cls}" title="${escapeHtml(s)}"></span>`;
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightText(text, keyword) {
      const base = escapeHtml(text || '');
      if (!keyword) return base;

      const kw = keyword.trim();
      if (!kw) return base;

      const pattern = new RegExp(escapeRegExp(kw), 'gi');
      return base.replace(pattern, match => `<mark class="kw-mark">${match}</mark>`);
    }

    function buildHeaderCell(label, key, extraClass = '', textAlignCenter = false) {
      const isActive = sortKey === key;
      const arrow = isActive ? (sortDir === 'asc' ? 'â–²' : 'â–¼') : '';
      const classes = [
        'sortable',
        isActive ? 'sortable-active' : '',
        extraClass || '',
        textAlignCenter ? 'text-center' : ''
      ].filter(Boolean).join(' ');

      return `
        <th class="${classes}" data-sort-key="${key}">
          <span class="th-label">${escapeHtml(label)}${
            arrow ? `<span class="sort-indicator">${arrow}</span>` : ''
          }</span>
          <span class="resize-handle"></span>
        </th>
      `;
    }

    function compareRows(a, b) {
      const direction = sortDir === 'desc' ? -1 : 1;
      const key = sortKey;

      function cmpString(sa, sb) {
        return sa.localeCompare(sb, 'ko-KR');
      }

      function tieBreak(a, b) {
        const nCmp = cmpString(a.productName || '', b.productName || '');
        if (nCmp !== 0) return nCmp;
        const cCmp = cmpString(a.colorName || '', b.colorName || '');
        if (cCmp !== 0) return cCmp;
        return cmpString(a.colorCode || '', b.colorCode || '');
      }

      if (key === 'stock') {
        const aNum = (typeof a.stockNum === 'number') ? a.stockNum : -1;
        const bNum = (typeof b.stockNum === 'number') ? b.stockNum : -1;
        if (aNum !== bNum) {
          return (aNum < bNum ? -1 : 1) * direction;
        }
        return tieBreak(a, b);
      }

      let valA = '';
      let valB = '';

      switch (key) {
        case 'productName': valA = a.productName || ''; valB = b.productName || ''; break;
        case 'colorName':   valA = a.colorName || '';   valB = b.colorName || '';   break;
        case 'barcode':     valA = a.barcode || '';     valB = b.barcode || '';     break;
        case 'productCode': valA = a.productCode || ''; valB = b.productCode || ''; break;
        case 'colorCode':   valA = a.colorCode || '';   valB = b.colorCode || '';   break;
        case 'size':        valA = a.size || '';        valB = b.size || '';        break;
        case 'material':    valA = a.material || '';    valB = b.material || '';    break;
        case 'warehouse':   valA = a.warehouse || '';   valB = b.warehouse || '';   break;
        default: return tieBreak(a, b);
      }

      const primary = cmpString(valA, valB);
      if (primary !== 0) return primary * direction;
      return tieBreak(a, b);
    }

    function search() {
      const kw = keywordInput.value.trim();
      lastKeyword = kw;

      if (!products.length) {
        statusEl.textContent = 'ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
        return;
      }
      if (!kw) {
        statusEl.textContent = 'ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        resultEl.innerHTML = '<div class="no-result">ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
        if (resultInfoEl) resultInfoEl.textContent = 'ê²€ìƒ‰ ì „ ì…ë‹ˆë‹¤.';
        return;
      }

      const lowerKw = kw.toLowerCase();
      const filteredProducts = products.filter(p => {
        const name      = (p.productName || '').toLowerCase();
        const code      = (p.productCode || '').toLowerCase();
        const colorCode = (p.colorCode   || '').toLowerCase();

        return (
          name.includes(lowerKw) ||
          code.includes(lowerKw) ||
          colorCode.includes(lowerKw)
        );
      });

      if (!filteredProducts.length) {
        statusEl.textContent = `"${kw}" ê²€ìƒ‰ ê²°ê³¼: 0ê°œ`;
        resultEl.innerHTML = '<div class="no-result">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
        if (resultInfoEl) resultInfoEl.textContent = `ê²€ìƒ‰ì–´ "${kw}" ê²°ê³¼ 0ê°œ`;
        return;
      }

      const rows = [];

      filteredProducts.forEach(p => {
        const entries = stockEntriesByColorCode[p.colorCode] || [];

        let useEntries;
        if (showWarehouse) {
          useEntries = entries;
        } else {
          useEntries = entries.filter(e => e.warehouse === 'ì£¼í¬ë¬¼ë¥˜');
        }

        if (!useEntries.length) {
          rows.push({
            productName: p.productName || '',
            colorName:   p.colorName   || '',
            barcode:     p.barcode     || '',
            productCode: p.productCode || '',
            colorCode:   p.colorCode   || '',
            size:        sizeByColorCode[p.colorCode] || '',
            material:    p.material    || '',
            warehouse:   '',
            stockNum:    null,
            stockStr:    '',
            stockClass:  '',
            rawName:     p.rawName     || '',
            colorCodeKey: p.colorCode  || ''
          });
          return;
        }

        let sortedEntries = useEntries;
        if (showWarehouse) {
          sortedEntries = [...useEntries].sort((a, b) => {
            const aw = a.warehouse || '';
            const bw = b.warehouse || '';
            if (aw === 'ì£¼í¬ë¬¼ë¥˜' && bw !== 'ì£¼í¬ë¬¼ë¥˜') return -1;
            if (bw === 'ì£¼í¬ë¬¼ë¥˜' && aw !== 'ì£¼í¬ë¬¼ë¥˜') return 1;
            return aw.localeCompare(bw, 'ko-KR');
          });
        }

        sortedEntries.forEach(entry => {
          const stockNum = entry.qty;
          const stockStr = String(stockNum);
          let stockClass = 'stock-pill stock-pill-green';
          if (!isNaN(stockNum)) {
            if (stockNum >= 100) stockClass = 'stock-pill stock-pill-green';
            else if (stockNum >= 10) stockClass = 'stock-pill stock-pill-yellow';
            else if (stockNum >= 0) stockClass = 'stock-pill stock-pill-red';
          }

          rows.push({
            productName: p.productName || '',
            colorName:   p.colorName   || '',
            barcode:     p.barcode     || '',
            productCode: p.productCode || '',
            colorCode:   p.colorCode   || '',
            size:        entry.size || sizeByColorCode[p.colorCode] || '',
            material:    p.material    || '',
            warehouse:   showWarehouse ? (entry.warehouse || '') : '',
            stockNum,
            stockStr,
            stockClass,
            rawName:     p.rawName     || '',
            colorCodeKey: p.colorCode  || ''
          });
        });
      });

      let usedRows = rows;
      if (inStockOnly) {
        usedRows = rows.filter(r => typeof r.stockNum === 'number' && r.stockNum > 0);
      }

      if (!usedRows.length) {
        statusEl.innerHTML = `"${kw}" ê²€ìƒ‰ ê²°ê³¼: <strong>0í–‰</strong> (ì¬ê³  ìˆìŒë§Œ í•„í„° ì ìš©)`;
        resultEl.innerHTML = '<div class="no-result">ì¡°ê±´ì— ë§ëŠ” ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        if (resultInfoEl) {
          resultInfoEl.innerHTML = `"${escapeHtml(kw)}" / í–‰ 0ê°œ <span class="badge-filter">ì¬ê³  ìˆìŒë§Œ</span>`;
        }
        return;
      }

      usedRows.sort(compareRows);

      statusEl.innerHTML = `"${kw}" ê²€ìƒ‰ ê²°ê³¼: <strong>${usedRows.length}í–‰</strong>`;
      if (resultInfoEl) {
        const countStr = usedRows.length.toLocaleString();
        if (inStockOnly) {
          resultInfoEl.innerHTML =
            `"${escapeHtml(kw)}" / í–‰ ${countStr}ê°œ <span class="badge-filter">ì¬ê³  ìˆìŒë§Œ</span>`;
        } else {
          resultInfoEl.textContent = `"${kw}" / í–‰ ${countStr}ê°œ`;
        }
      }

      let headerHtml = '<tr>';
      headerHtml += buildHeaderCell('ìƒí’ˆëª…', 'productName', 'col-product');
      headerHtml += buildHeaderCell('ì¹¼ë¼ëª…', 'colorName', 'col-color');
      headerHtml += buildHeaderCell('ë°”ì½”ë“œ', 'barcode');
      headerHtml += buildHeaderCell('ìƒí’ˆì½”ë“œ', 'productCode', 'col-pcode');
      headerHtml += buildHeaderCell('ìƒí’ˆì¹¼ë¼ì½”ë“œ', 'colorCode');
      headerHtml += buildHeaderCell('ì‚¬ì´ì¦ˆ', 'size');

      if (showMaterial) headerHtml += buildHeaderCell('ì†Œì¬', 'material');
      if (showWarehouse) headerHtml += buildHeaderCell('ì°½ê³ ', 'warehouse', 'col-warehouse');

      headerHtml += buildHeaderCell('ì¬ê³ ', 'stock', 'stock-header', true);
      headerHtml += '</tr>';

      let bodyHtml = '';

      usedRows.forEach(r => {
        const opIndicatorHtml = buildOperationIndicator(r.colorCode);
        const rawNameEsc = escapeHtml(r.rawName || '');
        const hasRaw = r.rawName && r.rawName !== r.productName;
        const titleAttr = hasRaw ? ` title="${rawNameEsc}"` : '';

        const hasStock = r.stockStr && r.stockClass;
        const stockCellInner = hasStock ? `
          <span class="stock-cell" data-product-name="${escapeHtml(r.productName)}">
            <span class="${r.stockClass}">
              <span class="stock-pill-dot"></span>${escapeHtml(r.stockStr)}
            </span>
          </span>
        ` : '';

        bodyHtml += `
          <tr>
            <td class="product-name-cell col-product"${titleAttr} data-color-code="${escapeHtml(r.colorCodeKey || '')}">
              ${opIndicatorHtml}${highlightText(r.productName || '', lastKeyword)}
            </td>
            <td class="col-color">${highlightText(r.colorName || '', lastKeyword)}</td>
            <td>${highlightText(r.barcode || '', lastKeyword)}</td>
            <td class="col-pcode">${highlightText(r.productCode || '', lastKeyword)}</td>
            <td>${highlightText(r.colorCode || '', lastKeyword)}</td>
            <td>${highlightText(r.size || '', lastKeyword)}</td>
            ${showMaterial ? `<td>${highlightText(r.material || '', lastKeyword)}</td>` : ''}
            ${showWarehouse ? `<td class="col-warehouse">${highlightText(r.warehouse || '', lastKeyword)}</td>` : ''}
            <td class="text-right">${stockCellInner}</td>
          </tr>
        `;
      });

      const html = `
        <div class="result-table-wrap">
          <div class="result-scroll">
            <table>
              <thead>${headerHtml}</thead>
              <tbody>${bodyHtml}</tbody>
            </table>
          </div>
        </div>
      `;
      resultEl.innerHTML = html;
      updateLegendVisibility();
      attachTableHeaderEvents();
    }

    function attachTableHeaderEvents() {
      const table = resultEl.querySelector('table');
      if (!table) return;

      const thead = table.querySelector('thead');
      const ths = thead ? Array.from(thead.querySelectorAll('th')) : [];

      ths.forEach((th, index) => {
        const key = th.dataset.sortKey;

        if (key) {
          th.addEventListener('click', (e) => {
            if (e.target.classList.contains('resize-handle') || e.target.closest('.resize-handle')) return;
            if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
            else { sortKey = key; sortDir = 'asc'; }
            search();
          });
        }

        let handle = th.querySelector('.resize-handle');
        if (!handle) {
          handle = document.createElement('span');
          handle.className = 'resize-handle';
          th.appendChild(handle);
        }

        handle.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          startColumnResize(e, table, th, index);
        });
      });
    }

    function startColumnResize(e, table, th, colIndex) {
      const startX = e.pageX;
      const startWidth = th.offsetWidth;

      const bodyRows = table.tBodies[0] ? Array.from(table.tBodies[0].rows) : [];
      const thead = table.tHead;
      const headCells = thead ? Array.from(thead.rows[0].cells) : [];

      function onMouseMove(ev) {
        const dx = ev.pageX - startX;
        const newWidth = Math.max(60, startWidth + dx);

        if (headCells[colIndex]) headCells[colIndex].style.width = newWidth + 'px';
        bodyRows.forEach(row => {
          if (row.cells[colIndex]) row.cells[colIndex].style.width = newWidth + 'px';
        });
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    }

    // âœ… ì—”í„° ê²€ìƒ‰ (ë²„íŠ¼ ì—†ìŒ)
    keywordInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        search();
      }
    });

    // âœ… ì¹© í† ê¸€ ë³€ê²½ ì‹œ ë°”ë¡œ ì¬ê²€ìƒ‰ (í‚¤ì›Œë“œ ìˆì„ ë•Œë§Œ)
    toggleMaterialInput.addEventListener('change', () => {
      showMaterial = toggleMaterialInput.checked;
      if (keywordInput.value.trim()) search();
    });

    toggleWarehouseInput.addEventListener('change', () => {
      showWarehouse = toggleWarehouseInput.checked;
      if (keywordInput.value.trim()) search();
    });

    toggleInStockOnlyInput.addEventListener('change', () => {
      inStockOnly = toggleInStockOnlyInput.checked;
      if (keywordInput.value.trim()) search();
    });

    // ìƒí’ˆëª… í´ë¦­ â†’ ì›ë˜ ìƒí’ˆëª… ë³µì‚¬
    resultEl.addEventListener('click', e => {
      const cell = e.target.closest('.product-name-cell');
      if (!cell) return;

      const colorCode = cell.dataset.colorCode;
      if (!colorCode) return;

      const prod = products.find(p => p.colorCode === colorCode);
      if (!prod || !prod.rawName) return;

      const textToCopy = prod.rawName;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy)
          .then(() => showToast('ì›ë˜ ìƒí’ˆëª…ì„ ë³µì‚¬í–ˆì–´ìš”.'))
          .catch(() => showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = textToCopy;
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showToast('ì›ë˜ ìƒí’ˆëª…ì„ ë³µì‚¬í–ˆì–´ìš”.');
        } catch (err) {
          showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
        }
        document.body.removeChild(ta);
      }
    });

    // íƒ€ì´í‹€ í´ë¦­ â†’ ì‚¬ì´íŠ¸ ê²€ìƒ‰ í˜ì´ì§€
    document.addEventListener('DOMContentLoaded', () => {
      const titleEl = document.querySelector('.title-wrap h1');
      if (titleEl) {
        titleEl.addEventListener('click', () => {
          window.open('https://whitesands.co.kr/product/search.html?keyword=', '_blank');
        });
      }
    });

    // ì¬ê³  pill í´ë¦­ â†’ ê²€ìƒ‰ í›„ ì²« ìƒí’ˆìœ¼ë¡œ ì´ë™
    document.addEventListener("click", async (e) => {
      const cell = e.target.closest(".stock-cell");
      if (!cell) return;

      const productName = cell.dataset.productName;
      if (!productName) return;

      const searchUrl = `https://whitesands.co.kr/product/search.html?keyword=${encodeURIComponent(productName)}`;
      const newTab = window.open(searchUrl, "_blank");

      // ë‹¤ë¥¸ ë„ë©”ì¸ì´ë¼ ì ‘ê·¼ ì œí•œë  ìˆ˜ ìˆìŒ(ë¸Œë¼ìš°ì € ì •ì±…). ì‹¤íŒ¨í•´ë„ ê²€ìƒ‰ íƒ­ì€ ì—´ë¦¼.
      try {
        newTab.onload = async () => {
          try {
            const firstProductLink = newTab.document.querySelector(".prdList .thumbnail a");
            if (firstProductLink) {
              const href = firstProductLink.href.startsWith("http")
                ? firstProductLink.href
                : `https://whitesands.co.kr${firstProductLink.getAttribute("href")}`;
              newTab.location.href = href;
            } else {
              alert(`"${productName}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            }
          } catch (err) {
            console.error(err);
          }
        };
      } catch (e) {}
    });

    // ë‹¨ì¶•í‚¤: Ctrl+K / Cmd+K / /
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')) {
        e.preventDefault();
        keywordInput.focus();
        keywordInput.select();
        return;
      }
      if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
        const tag = document.activeElement && document.activeElement.tagName;
        if (tag !== 'INPUT' && tag !== 'TEXTAREA') {
          e.preventDefault();
          keywordInput.focus();
          keywordInput.select();
        }
      }
    });

    init();
  </script>
</body>
</html>




